<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>芬与萌的甜蜜空间</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root {
--primary-pink: #FF9EBC;
--light-pink: #FFC8DD;
--light-blue: #BDE0FE;
--accent-color: #A2D2FF;
--light-color: #FFF8FB;
--dark-color: #9D4E8C;
--text-color: #333;
--shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
--transition: all 0.3s ease;
}

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Noto Sans SC', sans-serif;
        line-height: 1.6;
        color: var(--text-color);
        background: linear-gradient(135deg, var(--light-pink) 0%, var(--light-blue) 100%);
        min-height: 100vh;
        overflow-x: hidden;
    }

    .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }

    /* 密码保护层 */
    #password-protection {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--light-pink) 0%, var(--light-blue) 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.5s ease;
    }

    .password-container {
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 40px;
        box-shadow: var(--shadow);
        text-align: center;
        max-width: 500px;
        width: 90%;
        backdrop-filter: blur(10px);
        border: 2px solid var(--primary-pink);
    }

    .password-container h2 {
        color: var(--dark-color);
        margin-bottom: 20px;
        font-size: 2.2rem;
    }

    .password-container p {
        margin-bottom: 30px;
        color: #666;
        font-size: 1.1rem;
    }

    .password-input {
        width: 100%;
        padding: 15px;
        border: 2px solid var(--primary-pink);
        border-radius: 10px;
        font-size: 1.1rem;
        margin-bottom: 20px;
        text-align: center;
        background-color: #FFF8FB;
    }

    .password-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(162, 210, 255, 0.3);
    }

    .password-btn {
        padding: 15px 30px;
        background-color: var(--primary-pink);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: var(--transition);
        width: 100%;
        margin-bottom: 15px;
        font-weight: 500;
    }

    .password-btn:hover {
        background-color: #ff7ba3;
        transform: translateY(-2px);
    }

    .password-error {
        color: #ff6b6b;
        margin-top: 10px;
        display: none;
        animation: shake 0.5s;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    /* 调试信息 */
    .debug-info {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 0.8rem;
        z-index: 99999;
        display: none;
    }

    /* 头部样式 */
    header {
        background: linear-gradient(to right, var(--primary-pink), var(--accent-color));
        color: white;
        padding: 1.5rem 0;
        box-shadow: var(--shadow);
        position: sticky;
        top: 0;
        z-index: 1000;
        backdrop-filter: blur(10px);
        display: none;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .logo i {
        font-size: 2rem;
    }

    .logo h1 {
        font-size: 1.8rem;
        font-weight: 700;
    }

    nav ul {
        display: flex;
        list-style: none;
        gap: 2rem;
    }

    nav a {
        color: white;
        text-decoration: none;
        font-weight: 500;
        font-size: 1.1rem;
        transition: var(--transition);
        padding: 5px 10px;
        border-radius: 5px;
    }

    nav a:hover, nav a.active {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
    }

    /* 主要内容区 */
    main {
        padding: 2rem 0;
        opacity: 0;
        animation: fadeIn 0.5s ease forwards;
        display: none;
    }

    @keyframes fadeIn {
        to { opacity: 1; }
    }

    .section-title {
        text-align: center;
        margin-bottom: 2rem;
        color: var(--dark-color);
        position: relative;
        padding-bottom: 10px;
    }

    .section-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 3px;
        background-color: var(--primary-pink);
        border-radius: 2px;
    }

    /* 首页样式 */
    #home {
        text-align: center;
        padding: 3rem 0;
    }

    .couple-name {
        font-size: 3rem;
        color: var(--dark-color);
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .tagline {
        font-size: 1.2rem;
        color: var(--dark-color);
        margin-bottom: 2rem;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    .photo-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 2rem;
    }

    .photo-item {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: var(--shadow);
        transition: var(--transition);
        height: 280px;
        position: relative;
    }

    .photo-item:hover {
        transform: translateY(-10px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    .photo-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: var(--transition);
    }

    .photo-item:hover img {
        transform: scale(1.05);
    }

    .photo-caption {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        color: white;
        padding: 20px 15px 10px;
        transform: translateY(5px);
        opacity: 0;
        transition: var(--transition);
    }

    .photo-item:hover .photo-caption {
        transform: translateY(0);
        opacity: 1;
    }

    /* ===== 新增：纪念日双计时样式 ===== */
    .countdown-dual-section {
        margin: 3rem 0;
    }

    .countdown-dual-container {
        background: linear-gradient(135deg, var(--light-pink), var(--accent-color));
        padding: 2.5rem;
        border-radius: 25px;
        margin: 2rem auto;
        max-width: 1000px;
        box-shadow: var(--shadow);
        text-align: center;
        backdrop-filter: blur(5px);
        border: 2px solid white;
    }

    .countdown-dual-title {
        color: var(--dark-color);
        margin-bottom: 1.5rem;
        font-size: 1.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

    .countdown-dual-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2.5rem;
        margin-top: 1.5rem;
    }

    @media (max-width: 768px) {
        .countdown-dual-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
    }

    .countdown-dual-box {
        background: white;
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .countdown-dual-box::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, var(--primary-pink), var(--accent-color));
    }

    .countdown-dual-box:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 25px rgba(0,0,0,0.15);
    }

    .countdown-dual-icon {
        font-size: 2.5rem;
        color: var(--dark-color);
        margin-bottom: 1.2rem;
    }

    .countdown-dual-box h3 {
        font-size: 1.4rem;
        color: var(--dark-color);
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    .countdown-number {
        font-size: 4rem;
        font-weight: 800;
        color: var(--dark-color);
        margin: 0.5rem 0;
        text-shadow: 3px 3px 6px rgba(0,0,0,0.1);
        background: linear-gradient(45deg, var(--primary-pink), var(--dark-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .countdown-label {
        font-size: 1.2rem;
        color: #666;
        margin-top: 0.8rem;
        font-weight: 500;
    }

    .countdown-breakdown {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .breakdown-item {
        text-align: center;
        padding: 1rem;
        background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
        border-radius: 15px;
        border: 1px solid rgba(255,255,255,0.3);
    }

    .breakdown-number {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 0.3rem;
    }

    .breakdown-label {
        font-size: 0.9rem;
        color: #777;
        font-weight: 500;
    }

    .progress-container {
        margin: 1.5rem 0;
    }

    .progress-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
        color: #666;
    }

    .progress-bar {
        height: 12px;
        background: var(--light-blue);
        border-radius: 6px;
        overflow: hidden;
        margin: 0.5rem 0;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-pink), var(--accent-color));
        width: 0%;
        transition: width 1s ease;
        border-radius: 6px;
        position: relative;
        overflow: hidden;
    }

    .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, 
            transparent, 
            rgba(255,255,255,0.3), 
            transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .next-event-info {
        margin-top: 1.5rem;
        padding: 1.2rem;
        background: rgba(255,255,255,0.9);
        border-radius: 15px;
        border-left: 5px solid var(--primary-pink);
        text-align: left;
    }

    .next-event-info h4 {
        color: var(--dark-color);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .next-event-date {
        font-size: 1.1rem;
        color: var(--primary-pink);
        font-weight: 600;
        margin: 0.5rem 0;
    }

    /* ===== 新增：功能卡片样式 ===== */
    .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin: 3rem 0;
    }

    .feature-card {
        background: white;
        padding: 2rem;
        border-radius: 20px;
        box-shadow: var(--shadow);
        transition: var(--transition);
        text-align: center;
        position: relative;
        overflow: hidden;
        border: 2px solid transparent;
    }

    .feature-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        border-color: var(--light-pink);
    }

    .feature-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, var(--primary-pink), var(--accent-color));
    }

    .feature-icon {
        font-size: 3rem;
        color: var(--primary-pink);
        margin-bottom: 1.5rem;
        height: 80px;
        width: 80px;
        background: rgba(255, 158, 188, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        transition: var(--transition);
    }

    .feature-card:hover .feature-icon {
        transform: scale(1.1) rotate(10deg);
        background: rgba(255, 158, 188, 0.2);
    }

    .feature-card h3 {
        color: var(--dark-color);
        margin-bottom: 1rem;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .feature-card p {
        color: #666;
        margin-bottom: 1.5rem;
        line-height: 1.6;
    }

    /* 照片网格 */
    .photo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 1rem;
    }

    .photo-grid img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 10px;
        cursor: pointer;
        transition: var(--transition);
        border: 2px solid white;
    }

    .photo-grid img:hover {
        transform: scale(1.05);
        border-color: var(--primary-pink);
    }

    /* 温度计样式 */
    .temperature-container {
        position: relative;
        width: 200px;
        height: 300px;
        background: linear-gradient(180deg, #f0f8ff 0%, #e6f7ff 100%);
        border-radius: 20px;
        margin: 0 auto;
        border: 2px solid var(--light-blue);
        overflow: hidden;
    }

    .temperature-scale {
        position: absolute;
        left: 30px;
        top: 20px;
        bottom: 20px;
        width: 20px;
        background: linear-gradient(180deg, 
            #00ff00 0%, 
            #ffff00 33%, 
            #ff9900 66%, 
            #ff0000 100%);
        border-radius: 10px;
        border: 2px solid white;
    }

    .temperature-mercury {
        position: absolute;
        bottom: 20px;
        left: 35px;
        width: 10px;
        height: 0;
        background: linear-gradient(180deg, #ff0000, #ff5500);
        border-radius: 5px;
        transition: height 1s ease;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
    }

    .temperature-value {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--dark-color);
    }

    .temperature-labels {
        position: absolute;
        right: 20px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        top: 20px;
        bottom: 20px;
    }

    .temperature-label {
        font-size: 0.9rem;
        color: #666;
    }

    /* 重要日期列表 */
    .important-dates-list {
        margin-top: 1.5rem;
    }

    .date-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        margin: 0.8rem 0;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        border-left: 5px solid var(--primary-pink);
        transition: var(--transition);
    }

    .date-item:hover {
        transform: translateX(5px);
        background: rgba(255, 200, 221, 0.3);
    }

    .date-icon {
        font-size: 1.2rem;
        margin-right: 10px;
    }

    .date-content {
        flex: 1;
        text-align: left;
    }

    .date-name {
        font-weight: 600;
        color: var(--dark-color);
    }

    .date-when {
        font-size: 0.9rem;
        color: #666;
        margin-top: 3px;
    }

    .date-countdown {
        font-weight: 700;
        color: var(--primary-pink);
        font-size: 1.1rem;
    }

    /* 音乐播放器样式 */
    .music-player {
        background: linear-gradient(135deg, #ff9ebc, #a2d2ff);
        border-radius: 20px;
        padding: 1.5rem;
        margin-top: 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .music-player::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80') center/cover;
        opacity: 0.1;
    }

    .player-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
        z-index: 1;
    }

    .play-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: white;
        border: none;
        color: var(--primary-pink);
        font-size: 1.5rem;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .play-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    }

    .player-info {
        flex: 1;
        margin-left: 1rem;
        color: white;
    }

    .song-title {
        font-weight: 600;
        font-size: 1.2rem;
    }

    .song-artist {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    /* 惊喜盒子样式 */
    .surprise-box {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 1.5rem auto;
        perspective: 1000px;
        cursor: pointer;
    }

    .surprise-box-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.8s;
        transform-style: preserve-3d;
    }

    .surprise-box:hover .surprise-box-inner {
        transform: rotateY(180deg);
    }

    .surprise-box-front, .surprise-box-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .surprise-box-front {
        background: linear-gradient(135deg, var(--primary-pink), var(--accent-color));
        color: white;
        border: 5px solid white;
    }

    .surprise-box-back {
        background: white;
        color: var(--dark-color);
        transform: rotateY(180deg);
        border: 5px solid var(--primary-pink);
    }

    /* 关于她页面 */
    #about-her {
        display: none;
    }

    .about-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-top: 2rem;
    }

    @media (max-width: 768px) {
        .about-container {
            grid-template-columns: 1fr;
        }
    }

    .about-card {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 25px;
        transition: var(--transition);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .about-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    .about-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .about-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, var(--primary-pink), var(--accent-color));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }

    .about-title {
        color: var(--dark-color);
        font-size: 1.5rem;
    }

    .about-content ul {
        list-style: none;
        padding-left: 0;
    }

    .about-content li {
        padding: 8px 0;
        border-bottom: 1px dashed #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .about-content li:last-child {
        border-bottom: none;
    }

    .relationship-timeline {
        grid-column: 1 / -1;
    }

    .timeline {
        position: relative;
        max-width: 800px;
        margin: 0 auto;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 2px;
        height: 100%;
        background-color: var(--primary-pink);
    }

    .timeline-item {
        display: flex;
        margin-bottom: 30px;
        position: relative;
    }

    .timeline-item:nth-child(odd) {
        justify-content: flex-end;
        padding-right: 50px;
    }

    .timeline-item:nth-child(even) {
        justify-content: flex-start;
        padding-left: 50px;
    }

    .timeline-content {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        padding: 20px;
        box-shadow: var(--shadow);
        width: 80%;
        max-width: 350px;
        position: relative;
        backdrop-filter: blur(5px);
    }

    .timeline-item:nth-child(odd) .timeline-content::after {
        content: '';
        position: absolute;
        right: -10px;
        top: 20px;
        width: 0;
        height: 0;
        border-top: 10px solid transparent;
        border-bottom: 10px solid transparent;
        border-left: 10px solid rgba(255, 255, 255, 0.9);
    }

    .timeline-item:nth-child(even) .timeline-content::after {
        content: '';
        position: absolute;
        left: -10px;
        top: 20px;
        width: 0;
        height: 0;
        border-top: 10px solid transparent;
        border-bottom: 10px solid transparent;
        border-right: 10px solid rgba(255, 255, 255, 0.9);
    }

    .timeline-date {
        font-weight: 700;
        color: var(--primary-pink);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .timeline-marker {
        position: absolute;
        width: 20px;
        height: 20px;
        background-color: var(--primary-pink);
        border-radius: 50%;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        border: 3px solid white;
        box-shadow: 0 0 0 3px var(--primary-pink);
    }

    /* 日记样式 - 增强版 */
    #diary {
        display: none;
    }

    .diary-container {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 30px;
        margin-top: 2rem;
    }

    @media (max-width: 992px) {
        .diary-container {
            grid-template-columns: 1fr;
        }
    }

    .diary-list {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 20px;
        max-height: 700px;
        overflow-y: auto;
        backdrop-filter: blur(5px);
    }

    .diary-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        flex-wrap: wrap;
        gap: 10px;
    }

    .diary-list-header h3 {
        color: var(--dark-color);
        margin: 0;
    }

    .diary-search {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 0.9rem;
        margin-bottom: 10px;
        background-color: white;
    }

    .diary-search:focus {
        outline: none;
        border-color: var(--primary-pink);
        box-shadow: 0 0 0 3px rgba(255, 158, 188, 0.2);
    }

    .diary-filter-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 10px;
    }

    .diary-tag-filter {
        padding: 3px 8px;
        background-color: #f0f0f0;
        border-radius: 12px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: var(--transition);
    }

    .diary-tag-filter:hover {
        background-color: var(--light-pink);
    }

    .diary-tag-filter.active {
        background-color: var(--primary-pink);
        color: white;
    }

    .diary-entries {
        list-style: none;
    }

    .diary-entry {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: var(--transition);
        border-left: 4px solid transparent;
        background-color: white;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }

    .diary-entry:hover {
        background-color: rgba(255, 200, 221, 0.3);
    }

    .diary-entry.active {
        background-color: rgba(255, 200, 221, 0.5);
        border-left-color: var(--primary-pink);
    }

    .diary-entry-thumbnail {
        flex-shrink: 0;
        width: 60px;
        height: 60px;
        border-radius: 8px;
        overflow: hidden;
        background-color: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ccc;
        font-size: 1.5rem;
    }

    .diary-entry-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .diary-entry-content {
        flex: 1;
        min-width: 0;
    }

    .diary-date {
        font-size: 0.9rem;
        color: #777;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .diary-mood {
        color: #ffb347;
        font-size: 0.9rem;
    }

    .diary-preview {
        font-size: 0.95rem;
        color: #555;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 5px;
    }

    .diary-tags {
        font-size: 0.8rem;
        color: #999;
    }

    .diary-editor {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 25px;
        display: flex;
        flex-direction: column;
        backdrop-filter: blur(5px);
    }

    .diary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .diary-date-input {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        background-color: white;
    }

    .diary-mood-selector {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        background-color: white;
    }

    .diary-title-input {
        width: 100%;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 1.2rem;
        margin-bottom: 20px;
        background-color: white;
    }

    /* 富文本工具栏 */
    .diary-toolbar {
        display: flex;
        gap: 5px;
        margin-bottom: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #eee;
        flex-wrap: wrap;
    }

    .toolbar-btn {
        width: 36px;
        height: 36px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .toolbar-btn:hover {
        background-color: #f0f0f0;
        transform: translateY(-2px);
    }

    .toolbar-btn.active {
        background-color: var(--light-pink);
        border-color: var(--primary-pink);
    }

    .diary-content {
        flex: 1;
        min-height: 400px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 1rem;
        line-height: 1.6;
        margin-bottom: 20px;
        resize: vertical;
        background-color: white;
        overflow-y: auto;
    }

    /* 图片附件区域 */
    .diary-attachments {
        margin-top: 20px;
        padding: 15px;
        border: 2px dashed var(--light-pink);
        border-radius: 10px;
        background-color: rgba(255, 255, 255, 0.8);
    }

    .attachments-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .attachments-title {
        color: var(--dark-color);
        font-size: 1.1rem;
    }

    .attachments-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }

    .attachment-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        height: 120px;
        background-color: #f5f5f5;
    }

    .attachment-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .attachment-remove {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 24px;
        height: 24px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
    }

    .attachment-upload {
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px dashed var(--primary-pink);
        border-radius: 8px;
        height: 120px;
        background-color: rgba(255, 158, 188, 0.1);
        cursor: pointer;
        transition: var(--transition);
    }

    .attachment-upload:hover {
        background-color: rgba(255, 158, 188, 0.2);
        transform: translateY(-2px);
    }

    .attachment-upload i {
        font-size: 2rem;
        color: var(--primary-pink);
    }

    /* 标签输入 */
    .diary-tags-input {
        margin-top: 15px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: white;
    }

    .tags-input-label {
        display: block;
        margin-bottom: 8px;
        color: var(--dark-color);
        font-weight: 500;
    }

    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 10px;
    }

    .diary-tag {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        background-color: var(--light-pink);
        border-radius: 15px;
        font-size: 0.85rem;
        color: var(--dark-color);
    }

    .tag-remove {
        background: none;
        border: none;
        color: var(--dark-color);
        cursor: pointer;
        padding: 0;
        font-size: 0.8rem;
    }

    .tag-input {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 5px 10px;
        font-size: 0.9rem;
        min-width: 100px;
    }

    .tag-input:focus {
        outline: none;
        border-color: var(--primary-pink);
    }

    .diary-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .btn {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background-color: var(--primary-pink);
        color: white;
    }

    .btn-primary:hover {
        background-color: #ff7ba3;
        transform: translateY(-2px);
    }

    .btn-secondary {
        background-color: #f0f0f0;
        color: #333;
    }

    .btn-secondary:hover {
        background-color: #e0e0e0;
        transform: translateY(-2px);
    }

    .btn-danger {
        background-color: #ff6b6b;
        color: white;
    }

    .btn-danger:hover {
        background-color: #ff5252;
        transform: translateY(-2px);
    }

    .btn-success {
        background-color: #51cf66;
        color: white;
    }

    .btn-success:hover {
        background-color: #40c057;
        transform: translateY(-2px);
    }

    .btn-export {
        background-color: #8a2be2;
        color: white;
    }

    .btn-export:hover {
        background-color: #7b1fd1;
        transform: translateY(-2px);
    }

    .btn-info {
        background-color: #4dabf7;
        color: white;
    }

    .btn-info:hover {
        background-color: #339af0;
        transform: translateY(-2px);
    }

    .btn-warning {
        background-color: #ff922b;
        color: white;
    }

    .btn-warning:hover {
        background-color: #ff7b00;
        transform: translateY(-2px);
    }

    /* 相册样式 */
    #gallery {
        display: none;
    }

    .upload-area {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        box-shadow: var(--shadow);
        padding: 30px;
        text-align: center;
        margin-bottom: 30px;
        border: 2px dashed var(--primary-pink);
        transition: var(--transition);
        backdrop-filter: blur(5px);
    }

    .upload-area:hover {
        border-color: var(--accent-color);
    }

    .upload-area i {
        font-size: 3rem;
        color: var(--primary-pink);
        margin-bottom: 15px;
    }

    .upload-btn {
        display: inline-block;
        margin-top: 15px;
        padding: 12px 30px;
        background-color: var(--primary-pink);
        color: white;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
    }

    .upload-btn:hover {
        background-color: var(--accent-color);
        transform: translateY(-2px);
    }

    .album-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 25px;
    }

    .album-item {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        overflow: hidden;
        box-shadow: var(--shadow);
        transition: var(--transition);
        backdrop-filter: blur(5px);
    }

    .album-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    .album-cover {
        height: 200px;
        overflow: hidden;
        position: relative;
    }

    .album-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: var(--transition);
    }

    .album-item:hover .album-cover img {
        transform: scale(1.05);
    }

    .album-info {
        padding: 20px;
    }

    .album-info h3 {
        margin-bottom: 10px;
        color: var(--dark-color);
    }

    .album-info p {
        color: #777;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* 纪念日样式 - 改进版 */
    #milestones {
        display: none;
    }

    .milestones-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 25px;
        margin-top: 2rem;
    }

    .milestone-card {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 25px;
        box-shadow: var(--shadow);
        text-align: center;
        transition: var(--transition);
        backdrop-filter: blur(5px);
        position: relative;
    }

    .milestone-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    .milestone-icon {
        width: 70px;
        height: 70px;
        background: linear-gradient(135deg, var(--primary-pink), var(--accent-color));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        color: white;
        font-size: 1.8rem;
    }

    .milestone-title {
        font-size: 1.3rem;
        color: var(--dark-color);
        margin-bottom: 15px;
    }

    .milestone-counters {
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
        gap: 15px;
    }

    .counter-box {
        flex: 1;
        padding: 15px;
        border-radius: 10px;
        background-color: rgba(255, 255, 255, 0.95);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        transition: var(--transition);
    }

    .counter-box:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .counter-label {
        font-size: 0.9rem;
        color: #777;
        margin-bottom: 8px;
    }

    .counter-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-pink);
    }

    .counter-unit {
        font-size: 0.9rem;
        color: #777;
        margin-left: 3px;
    }

    .milestone-date {
        color: #777;
        font-size: 0.9rem;
        margin-top: 10px;
    }

    /* 底部样式 */
    footer {
        background-color: var(--dark-color);
        color: white;
        padding: 2rem 0;
        margin-top: 3rem;
        text-align: center;
        display: none;
    }

    .footer-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
    }

    .heartbeat {
        color: var(--primary-pink);
        animation: heartbeat 1.5s infinite;
    }

    @keyframes heartbeat {
        0% { transform: scale(1); }
        5% { transform: scale(1.2); }
        10% { transform: scale(1.1); }
        15% { transform: scale(1.3); }
        50% { transform: scale(1); }
        100% { transform: scale(1); }
    }

    /* 编辑和删除按钮 */
    .edit-btn, .delete-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        padding: 5px 8px;
        border-radius: 5px;
        transition: var(--transition);
    }

    .edit-btn {
        color: var(--primary-pink);
    }

    .edit-btn:hover {
        background-color: rgba(255, 158, 188, 0.1);
        transform: translateY(-2px);
    }

    .delete-btn {
        color: #ff6b6b;
    }

    .delete-btn:hover {
        background-color: rgba(255, 107, 107, 0.1);
        transform: translateY(-2px);
    }

    .add-btn {
        margin-top: 10px;
        background-color: var(--light-blue);
        color: var(--dark-color);
        border: 1px solid var(--light-blue);
    }

    .add-btn:hover {
        background-color: #a9d1fc;
        transform: translateY(-2px);
    }

    /* 模态框 */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background-color: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .modal-title {
        font-size: 1.5rem;
        color: var(--dark-color);
    }

    .close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #777;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--dark-color);
    }

    .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        background-color: #fff;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-pink);
        box-shadow: 0 0 0 3px rgba(255, 158, 188, 0.2);
    }

    /* 设置面板 */
    .settings-panel {
        position: fixed;
        top: 100px;
        right: 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: var(--shadow);
        padding: 15px;
        z-index: 100;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .settings-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        color: var(--dark-color);
        padding: 8px;
        border-radius: 5px;
        transition: var(--transition);
    }

    .settings-btn:hover {
        background-color: rgba(255, 158, 188, 0.1);
        transform: translateY(-2px);
    }

    /* 导出选项 */
    .export-options {
        display: none;
        position: absolute;
        top: 50px;
        right: 0;
        background-color: white;
        border-radius: 10px;
        box-shadow: var(--shadow);
        padding: 15px;
        min-width: 200px;
    }

    .export-options.show {
        display: block;
    }

    .export-option {
        display: block;
        width: 100%;
        padding: 10px;
        text-align: left;
        background: none;
        border: none;
        cursor: pointer;
        transition: var(--transition);
        border-radius: 5px;
    }

    .export-option:hover {
        background-color: rgba(255, 158, 188, 0.1);
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        nav ul {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--primary-pink);
            flex-direction: column;
            padding: 1rem;
            gap: 0;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        nav ul.show {
            display: flex;
        }

        nav li {
            width: 100%;
        }

        nav a {
            display: block;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-menu-btn {
            display: block;
        }

        .couple-name {
            font-size: 2.2rem;
        }

        .photo-gallery {
            grid-template-columns: 1fr;
        }

        .diary-actions {
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
        }

        .milestones-container {
            grid-template-columns: 1fr;
        }

        .settings-panel {
            top: 80px;
            right: 10px;
        }
    }

    /* 浮动爱心 */
    .floating-heart {
        position: absolute;
        font-size: 1.5rem;
        color: var(--primary-pink);
        opacity: 0.7;
        z-index: -1;
        animation: float 15s infinite linear;
    }

    @keyframes float {
        0% { transform: translateY(0) rotate(0deg); opacity: 0.7; }
        100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
    }

    /* 加载动画 */
    .loading-spinner {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 158, 188, 0.3);
        border-top-color: var(--primary-pink);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* 自动保存提示 */
    .auto-save-notice {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #51cf66;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideIn 0.3s ease;
        display: none;
    }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* 打印样式 */
    @media print {
        header, footer, .settings-panel, .btn, .diary-list {
            display: none !important;
        }

        .diary-editor {
            box-shadow: none;
            border: 1px solid #ddd;
        }

        .diary-content {
            min-height: auto;
            border: none;
        }

        .diary-attachments {
            break-inside: avoid;
        }
    }

    /* 日记图片预览 */
    .diary-image-preview {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        margin: 10px 0;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: var(--transition);
    }

    .diary-image-preview:hover {
        transform: scale(1.02);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    /* 全屏图片查看 */
    .image-viewer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 3000;
        justify-content: center;
        align-items: center;
    }

    .image-viewer img {
        max-width: 90%;
        max-height: 90%;
        border-radius: 5px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
    }

    .close-viewer {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        color: white;
        font-size: 2rem;
        cursor: pointer;
    }

    /* 标签气泡 */
    .tag-bubble {
        display: inline-block;
        padding: 4px 12px;
        background-color: var(--light-pink);
        border-radius: 15px;
        font-size: 0.85rem;
        color: var(--dark-color);
        margin-right: 5px;
        margin-bottom: 5px;
        transition: var(--transition);
    }

    .tag-bubble:hover {
        background-color: var(--primary-pink);
        color: white;
        transform: translateY(-2px);
    }

    /* 进度条 */
    .progress-bar {
        width: 100%;
        height: 6px;
        background-color: #f0f0f0;
        border-radius: 3px;
        margin: 10px 0;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background-color: var(--primary-pink);
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    /* 日记统计 */
    .diary-stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
        padding: 15px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        box-shadow: var(--shadow);
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-pink);
    }

    .stat-label {
        font-size: 0.9rem;
        color: #777;
    }
</style>

</head>
<body>
<!-- 密码保护层 -->
<div id="password-protection">
<div class="password-container">
<h2>芬与萌的甜蜜空间</h2>
<p>请输入访问密码查看我们的专属空间</p>
<input type="password" class="password-input" id="password-input" placeholder="请输入密码" autocomplete="off">
<button class="password-btn" id="password-submit">进入我们的空间</button>
<button class="password-btn" id="emergency-access" style="background-color: #ff6b6b;">
    <i class="fas fa-key"></i> 紧急访问（重置密码）
</button>
<div class="password-error" id="password-error">密码错误，请重新输入</div>
<p style="font-size: 0.9rem; color: #777; margin-top: 20px;">提示：我们相遇和在一起的日期</p>
<p style="font-size: 0.8rem; color: #999; margin-top: 10px;">默认密码：250406250527</p>
</div>
</div>

<!-- 调试信息 -->
<div class="debug-info" id="debugInfo"></div>

<!-- 加载动画 -->
<div class="loading-spinner" id="loadingSpinner">
    <div class="spinner"></div>
</div>

<!-- 浮动爱心背景 -->
<div id="floating-hearts"></div>

<!-- 自动保存提示 -->
<div class="auto-save-notice" id="autoSaveNotice">
    <i class="fas fa-save"></i>
    <span>日记已自动保存</span>
</div>

<!-- 图片查看器 -->
<div class="image-viewer" id="imageViewer">
    <button class="close-viewer" id="closeImageViewer">&times;</button>
    <img id="viewerImage" src="" alt="">
</div>

<!-- 设置面板 -->
<div class="settings-panel" id="settingsPanel" style="display: none;">
    <button class="settings-btn" id="export-btn" title="导出数据">
        <i class="fas fa-download"></i>
    </button>
    <button class="settings-btn" id="change-password-btn" title="修改密码">
        <i class="fas fa-key"></i>
    </button>
    <button class="settings-btn" id="backup-btn" title="备份数据">
        <i class="fas fa-save"></i>
    </button>
    <button class="settings-btn" id="debug-toggle" title="调试模式">
        <i class="fas fa-bug"></i>
    </button>

    <!-- 导出选项 -->
    <div class="export-options" id="export-options">
        <button class="export-option" id="export-diary">
            <i class="fas fa-book"></i> 导出日记
        </button>
        <button class="export-option" id="export-all">
            <i class="fas fa-file-archive"></i> 导出所有数据
        </button>
        <button class="export-option" id="export-photos">
            <i class="fas fa-images"></i> 导出照片链接
        </button>
    </div>
</div>

<!-- 网站头部 -->
<header id="site-header">
    <div class="container header-content">
        <div class="logo">
            <i class="fas fa-heart"></i>
            <h1 id="site-title">芬与萌的甜蜜空间</h1>
            <button class="edit-btn" id="edit-site-title" title="编辑网站标题">
                <i class="fas fa-edit"></i>
            </button>
        </div>

        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>

        <nav>
            <ul id="mainMenu">
                <li><a href="#" class="nav-link active" data-section="home">首页</a></li>
                <li><a href="#" class="nav-link" data-section="about-her">关于她</a></li>
                <li><a href="#" class="nav-link" data-section="diary">恋爱日记</a></li>
                <li><a href="#" class="nav-link" data-section="gallery">甜蜜相册</a></li>
                <li><a href="#" class="nav-link" data-section="milestones">纪念日</a></li>
                <li><a href="#" class="nav-link" data-section="special-features">特别功能</a></li>
            </ul>
        </nav>
    </div>
</header>

<!-- 主要内容区 -->
<main id="site-content">
    <div class="container">
        <!-- 首页 -->
        <section id="home" class="section active">
            <h2 class="couple-name" id="couple-name-title">
                <span id="couple-name-text">芬与萌的甜蜜空间</span>
                <button class="edit-btn" id="edit-couple-name" title="编辑情侣名称">
                    <i class="fas fa-edit"></i>
                </button>
            </h2>

            <p class="tagline" id="home-tagline">
                <span id="tagline-text">这里记录着我们每一个甜蜜瞬间，从游戏世界的初遇到现实生活的相爱，每一个回忆都值得珍藏。这是我们专属的小天地，只属于我们两个人的故事。</span>
                <button class="edit-btn" id="edit-tagline" title="编辑首页描述">
                    <i class="fas fa-edit"></i>
                </button>
            </p>

            <!-- ===== 新增：纪念日双计时显示 ===== -->
            <div class="countdown-dual-section">
                <div class="countdown-dual-container">
                    <div class="countdown-dual-title">
                        <i class="fas fa-heart"></i>
                        我们的时间记忆
                        <i class="fas fa-heart"></i>
                    </div>
                    
                    <div class="countdown-dual-grid">
                        <!-- 正计时：已经在一起的天数 -->
                        <div class="countdown-dual-box">
                            <div class="countdown-dual-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <h3>我们在一起</h3>
                            <div class="countdown-number" id="days-together">0</div>
                            <div class="countdown-label">天</div>
                            
                            <div class="countdown-breakdown">
                                <div class="breakdown-item">
                                    <div class="breakdown-number" id="months-together">0</div>
                                    <div class="breakdown-label">个月</div>
                                </div>
                                <div class="breakdown-item">
                                    <div class="breakdown-number" id="hours-together">0</div>
                                    <div class="breakdown-label">小时</div>
                                </div>
                                <div class="breakdown-item">
                                    <div class="breakdown-number" id="minutes-together">0</div>
                                    <div class="breakdown-label">分钟</div>
                                </div>
                            </div>
                            
                            <div class="progress-container">
                                <div class="progress-info">
                                    <span>今年已过:</span>
                                    <span id="year-progress-text">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="year-progress"></div>
                                </div>
                            </div>
                            
                            <div class="next-event-info">
                                <h4><i class="fas fa-calendar-star"></i> 纪念日信息</h4>
                                <p>纪念日: <span id="anniversary-date-display">2025-05-27</span></p>
                                <p>下次周年: <span id="next-anniversary-date">2026-05-27</span></p>
                            </div>
                        </div>
                        
                        <!-- 倒计时：距离下个纪念日 -->
                        <div class="countdown-dual-box">
                            <div class="countdown-dual-icon">
                                <i class="fas fa-hourglass-end"></i>
                            </div>
                            <h3>距离下个周年</h3>
                            <div class="countdown-number" id="days-remaining">0</div>
                            <div class="countdown-label">天</div>
                            
                            <div class="countdown-breakdown">
                                <div class="breakdown-item">
                                    <div class="breakdown-number" id="weeks-remaining">0</div>
                                    <div class="breakdown-label">周</div>
                                </div>
                                <div class="breakdown-item">
                                    <div class="breakdown-number" id="hours-remaining">0</div>
                                    <div class="breakdown-label">小时</div>
                                </div>
                                <div class="breakdown-item">
                                    <div class="breakdown-number" id="minutes-remaining">0</div>
                                    <div class="breakdown-label">分钟</div>
                                </div>
                            </div>
                            
                            <div class="progress-container">
                                <div class="progress-info">
                                    <span>周年进度:</span>
                                    <span id="anniversary-progress-text">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="anniversary-progress"></div>
                                </div>
                            </div>
                            
                            <div class="next-event-info">
                                <h4><i class="fas fa-bell"></i> 下一个重要日子</h4>
                                <div id="next-special-day">
                                    加载中...
                                </div>
                                <div class="next-event-date" id="next-event-date">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px dashed var(--light-pink);">
                        <p style="color: #666; font-size: 0.95rem;">
                            <i class="fas fa-info-circle"></i> 时间会记录我们相爱的每一刻，从初遇到永远 ❤️
                        </p>
                    </div>
                </div>
            </div>

            <div class="photo-gallery" id="home-gallery">
                <!-- 首页照片将通过JS动态添加 -->
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" id="add-home-photo">
                    <i class="fas fa-plus"></i> 添加首页照片
                </button>
            </div>
        </section>

        <!-- 关于她 -->
        <section id="about-her" class="section">
            <h2 class="section-title">关于她
                <button class="edit-btn" id="edit-about-her-title" title="编辑标题">
                    <i class="fas fa-edit"></i>
                </button>
            </h2>

            <div class="about-container" id="about-her-container">
                <!-- 关于她的内容将通过JS动态添加 -->
            </div>
        </section>

        <!-- 恋爱日记 - 增强版 -->
        <section id="diary" class="section">
            <h2 class="section-title">恋爱日记
                <button class="edit-btn" id="edit-diary-title" title="编辑标题">
                    <i class="fas fa-edit"></i>
                </button>
            </h2>

            <!-- 日记统计 -->
            <div class="diary-stats" id="diaryStats">
                <div class="stat-item">
                    <div class="stat-value" id="totalDiaries">0</div>
                    <div class="stat-label">总日记数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalImages">0</div>
                    <div class="stat-label">图片总数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalTags">0</div>
                    <div class="stat-label">标签总数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="firstDiaryDate">-</div>
                    <div class="stat-label">第一篇日记</div>
                </div>
            </div>

            <div class="diary-container">
                <div class="diary-list">
                    <div class="diary-list-header">
                        <h3>日记列表</h3>
                        <button class="btn add-btn" id="new-diary-btn" style="padding: 5px 10px; font-size: 0.9rem;">
                            <i class="fas fa-plus"></i> 新建日记
                        </button>
                    </div>

                    <!-- 日记搜索和筛选 -->
                    <input type="text" class="diary-search" id="diarySearch" placeholder="搜索日记标题或内容...">

                    <div class="diary-filter-tags" id="diaryFilterTags">
                        <!-- 标签筛选将通过JS动态添加 -->
                    </div>

                    <div style="text-align: center; margin-bottom: 10px;">
                        <button class="btn btn-secondary" id="backup-diaries-btn" style="padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;">
                            <i class="fas fa-download"></i> 备份
                        </button>
                        <button class="btn btn-secondary" id="restore-diaries-btn" style="padding: 5px 10px; font-size: 0.8rem;">
                            <i class="fas fa-upload"></i> 恢复
                        </button>
                    </div>

                    <ul class="diary-entries" id="diaryEntries">
                        <!-- 日记条目将通过JS动态添加 -->
                    </ul>
                </div>

                <div class="diary-editor">
                    <div class="diary-header">
                        <input type="date" class="diary-date-input" id="diaryDate" value="">

                        <select class="diary-mood-selector" id="diaryMood">
                            <option value="">选择心情</option>
                            <option value="😊">😊 开心</option>
                            <option value="😍">😍 甜蜜</option>
                            <option value="🥰">🥰 幸福</option>
                            <option value="😘">😘 爱你</option>
                            <option value="🤗">🤗 拥抱</option>
                            <option value="😢">😢 感动</option>
                            <option value="🤔">🤔 思考</option>
                            <option value="😎">😎 酷</option>
                            <option value="🤩">🤩 兴奋</option>
                            <option value="🥳">🥳 庆祝</option>
                        </select>

                        <div class="diary-actions">
                            <button class="btn btn-danger" id="deleteDiaryBtn">
                                <i class="fas fa-trash"></i> 删除日记
                            </button>
                            <button class="btn btn-secondary" id="saveDraftBtn">
                                <i class="fas fa-save"></i> 保存草稿
                            </button>
                            <button class="btn btn-primary" id="saveDiaryBtn">
                                <i class="fas fa-check"></i> 保存日记
                            </button>
                        </div>
                    </div>

                    <input type="text" class="diary-title-input" id="diaryTitle" placeholder="日记标题...">

                    <!-- 富文本工具栏 -->
                    <div class="diary-toolbar">
                        <button class="toolbar-btn" id="boldBtn" title="加粗">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button class="toolbar-btn" id="italicBtn" title="斜体">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button class="toolbar-btn" id="underlineBtn" title="下划线">
                            <i class="fas fa-underline"></i>
                        </button>
                        <button class="toolbar-btn" id="insertImageBtn" title="插入图片">
                            <i class="fas fa-image"></i>
                        </button>
                        <button class="toolbar-btn" id="insertDateBtn" title="插入日期">
                            <i class="fas fa-calendar-day"></i>
                        </button>
                        <button class="toolbar-btn" id="clearFormatBtn" title="清除格式">
                            <i class="fas fa-eraser"></i>
                        </button>
                    </div>

                    <div class="diary-content" id="diaryContent" contenteditable="true" placeholder="写下今天的甜蜜故事..."></div>

                    <!-- 图片附件区域 -->
                    <div class="diary-attachments">
                        <div class="attachments-header">
                            <div class="attachments-title">
                                <i class="fas fa-paperclip"></i> 图片附件
                            </div>
                            <div>
                                <button class="btn btn-secondary" id="addAttachmentBtn" style="padding: 5px 10px; font-size: 0.9rem;">
                                    <i class="fas fa-plus"></i> 添加图片
                                </button>
                                <input type="file" id="attachmentUpload" accept="image/*" multiple style="display: none;">
                            </div>
                        </div>
                        <div class="attachments-grid" id="attachmentsGrid">
                            <!-- 附件将通过JS动态添加 -->
                            <div class="attachment-upload" id="attachmentUploadArea">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                        </div>
                    </div>

                    <!-- 标签输入 -->
                    <div class="diary-tags-input">
                        <div class="tags-input-label">标签 (按回车添加)</div>
                        <div class="tags-container" id="tagsContainer">
                            <!-- 标签将通过JS动态添加 -->
                        </div>
                        <input type="text" class="tag-input" id="tagInput" placeholder="输入标签并按回车添加...">
                        <div style="font-size: 0.8rem; color: #777; margin-top: 5px;">常用标签: 甜蜜、约会、礼物、旅行、日常、纪念</div>
                    </div>

                    <div class="diary-actions">
                        <button class="btn btn-info" id="printDiaryBtn">
                            <i class="fas fa-print"></i> 打印日记
                        </button>
                        <button class="btn btn-warning" id="exportDiaryBtn">
                            <i class="fas fa-file-pdf"></i> 导出PDF
                        </button>
                        <button class="btn btn-danger" id="deleteDiaryBtn2">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                        <button class="btn btn-success" id="saveDiaryBtn2">
                            <i class="fas fa-check"></i> 保存
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 甜蜜相册 -->
        <section id="gallery" class="section">
            <h2 class="section-title">甜蜜相册
                <button class="edit-btn" id="edit-gallery-title" title="编辑标题">
                    <i class="fas fa-edit"></i>
                </button>
            </h2>

            <div class="upload-area">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>上传我们的照片</h3>
                <p>将照片拖放到这里，或点击按钮选择文件</p>
                <div class="upload-btn" id="uploadBtn">选择照片</div>
                <input type="file" id="photoUpload" accept="image/*" multiple style="display: none;">
            </div>

            <div class="album-container" id="albumContainer">
                <!-- 相册将通过JS动态添加 -->
            </div>
        </section>

        <!-- 纪念日 -->
        <section id="milestones" class="section">
            <h2 class="section-title">纪念日
                <button class="edit-btn" id="edit-milestones-title" title="编辑标题">
                    <i class="fas fa-edit"></i>
                </button>
            </h2>

            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-primary" id="add-milestone-btn">
                    <i class="fas fa-plus"></i> 添加纪念日
                </button>
            </div>

            <div class="milestones-container" id="milestonesContainer">
                <!-- 纪念日将通过JS动态添加 -->
            </div>
        </section>
        
        <!-- ===== 新增：特别功能区域 ===== -->
        <section id="special-features" class="section" style="display: none;">
            <h2 class="section-title">特别功能
                <button class="edit-btn" id="edit-features-title" title="编辑标题">
                    <i class="fas fa-edit"></i>
                </button>
            </h2>
            
            <div class="features-grid">
                <!-- 功能1：恋爱温度计 -->
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-temperature-high"></i>
                    </div>
                    <h3>恋爱温度计</h3>
                    <p>实时显示我们的爱情温度，今天暖暖的！</p>
                    
                    <div class="temperature-container">
                        <div class="temperature-scale"></div>
                        <div class="temperature-mercury" id="temperature-mercury"></div>
                        <div class="temperature-value" id="temperature-value">36.5°</div>
                        <div class="temperature-labels">
                            <div class="temperature-label">100°</div>
                            <div class="temperature-label">75°</div>
                            <div class="temperature-label">50°</div>
                            <div class="temperature-label">25°</div>
                            <div class="temperature-label">0°</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <p id="temperature-message">今天温度正常，继续保持哦！</p>
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="increaseTemperature()">
                                <i class="fas fa-fire"></i> 升温
                            </button>
                            <button class="btn btn-secondary" onclick="sendLoveMessage()">
                                <i class="fas fa-heart"></i> 传情
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 功能2：重要日期提醒 -->
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-calendar-star"></i>
                    </div>
                    <h3>重要日期提醒</h3>
                    <p>记录每一个值得纪念的日子，不错过任何重要时刻</p>
                    
                    <div class="important-dates-list" id="important-dates-list">
                        <!-- 日期将通过JS动态添加 -->
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <button class="btn btn-primary" onclick="addImportantDate()" style="width: 100%;">
                            <i class="fas fa-plus"></i> 添加重要日期
                        </button>
                    </div>
                </div>
                
                <!-- 功能3：我们的音乐 -->
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-music"></i>
                    </div>
                    <h3>我们的音乐</h3>
                    <p>属于我们的专属歌单，每首歌都有特别的回忆</p>
                    
                    <div class="music-player">
                        <div class="player-controls">
                            <button class="play-btn" id="play-btn">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="player-info">
                                <div class="song-title" id="current-song">我们的爱</div>
                                <div class="song-artist" id="current-artist">专属旋律</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1.5rem;">
                            <select class="form-control" id="song-selector" style="background: white; color: #333;">
                                <option value="0">🎵 我们的爱 - 专属旋律</option>
                                <option value="1">🎶 甜蜜蜜 - 邓丽君</option>
                                <option value="2">💖 简单爱 - 周杰伦</option>
                                <option value="3">🎼 因为爱情 - 王菲/陈奕迅</option>
                                <option value="4">🎹 最浪漫的事 - 赵咏华</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <button class="btn btn-secondary" onclick="addCustomSong()" style="width: 100%;">
                            <i class="fas fa-plus"></i> 添加我们的歌
                        </button>
                    </div>
                </div>
                
                <!-- 功能4：惊喜盒子 -->
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-gift"></i>
                    </div>
                    <h3>惊喜盒子</h3>
                    <p>点击打开随机惊喜，每天都有小确幸</p>
                    
                    <div class="surprise-box" onclick="openSurprise()">
                        <div class="surprise-box-inner">
                            <div class="surprise-box-front">
                                <i class="fas fa-gift" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h3>点击打开</h3>
                                <p>今日惊喜</p>
                            </div>
                            <div class="surprise-box-back" id="surprise-content">
                                <i class="fas fa-heart" style="font-size: 2rem; color: var(--primary-pink); margin-bottom: 1rem;"></i>
                                <h3>每日情话</h3>
                                <p id="daily-love-message">加载中...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <p style="color: #666; font-size: 0.9rem;">
                            <i class="fas fa-lightbulb"></i> 每天可以打开一次，记录今日的甜蜜心情
                        </p>
                    </div>
                </div>
                
                <!-- 功能5：记忆相册 -->
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-images"></i>
                    </div>
                    <h3>记忆相册</h3>
                    <p>快速浏览我们所有的甜蜜瞬间</p>
                    
                    <div class="photo-grid" id="memory-gallery">
                        <!-- 照片将通过JS动态添加 -->
                    </div>
                    
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button class="btn btn-primary" onclick="viewMemoryGallery()">
                            <i class="fas fa-expand"></i> 浏览相册
                        </button>
                        <button class="btn btn-secondary" onclick="uploadMemoryPhoto()" style="margin-left: 10px;">
                            <i class="fas fa-upload"></i> 上传照片
                        </button>
                    </div>
                </div>
                
                <!-- 功能6：恋爱测试 -->
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-heart-circle-check"></i>
                    </div>
                    <h3>恋爱测试</h3>
                    <p>测试我们对彼此的了解程度</p>
                    
                    <div style="margin: 1.5rem 0; text-align: center;">
                        <div style="font-size: 2rem; color: var(--primary-pink); margin-bottom: 1rem;">
                            ❤️ 💖 💕
                        </div>
                        <p>通过趣味问答加深彼此的了解</p>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <button class="btn btn-primary" onclick="startLoveQuiz()" style="width: 100%;">
                            <i class="fas fa-play"></i> 开始测试
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 留言区域 -->
        <section style="margin: 4rem 0; padding: 2rem; background: white; border-radius: 20px; box-shadow: var(--shadow);">
            <h2 style="text-align: center; margin-bottom: 2rem; color: var(--dark-color);">
                <i class="fas fa-comment-dots"></i> 爱的留言板
            </h2>
            
            <div style="max-width: 600px; margin: 0 auto;">
                <textarea id="love-note" placeholder="写下你想对TA说的话..." 
                          style="width: 100%; height: 120px; padding: 15px; border: 2px solid var(--light-pink); 
                                 border-radius: 15px; font-family: inherit; font-size: 1rem; 
                                 margin-bottom: 1rem; resize: vertical;"></textarea>
                
                <button onclick="addLoveNote()" class="btn" style="width: 100%; padding: 15px;">
                    <i class="fas fa-paper-plane"></i> 发送爱的留言
                </button>
                
                <div id="notes-container" style="margin-top: 2rem;">
                    <!-- 留言会显示在这里 -->
                </div>
            </div>
        </section>
    </div>
</main>

<!-- 网站底部 -->
<footer id="site-footer">
    <div class="container footer-content">
        <p id="footer-text">© 2025 芬与萌的甜蜜空间 | 游戏中的<span class="heartbeat">饭饭</span>与<span class="heartbeat">南書</span>，现实中的<span class="heartbeat">芬</span>与<span class="heartbeat">萌</span></p>
        <p id="footer-quote">每一天都因为有你而更加美好 ❤️</p>
        <button class="edit-btn" id="edit-footer" style="color: white;" title="编辑底部文字">
            <i class="fas fa-edit"></i> 编辑
        </button>
    </div>
</footer>

<!-- 编辑模态框 -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">编辑</h3>
            <button class="close-modal" id="closeModal">&times;</button>
        </div>
        <div id="modalBody">
            <!-- 模态框内容将动态填充 -->
        </div>
    </div>
</div>

<!-- 图片上传模态框 -->
<div class="modal" id="imageModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">添加/编辑照片</h3>
            <button class="close-modal" id="closeImageModal">&times;</button>
        </div>
        <div id="imageModalBody">
            <div class="form-group">
                <label for="imageUrl">图片URL</label>
                <input type="text" id="imageUrl" class="form-control" placeholder="输入图片链接或上传图片">
            </div>
            <div class="form-group">
                <label for="imageFile">或上传图片</label>
                <input type="file" id="imageFile" class="form-control" accept="image/*">
            </div>
            <div class="form-group">
                <label for="imageTitle">图片标题</label>
                <input type="text" id="imageTitle" class="form-control" placeholder="输入图片标题">
            </div>
            <div class="form-group">
                <label for="imageDescription">图片描述</label>
                <textarea id="imageDescription" class="form-control" placeholder="输入图片描述" rows="3"></textarea>
            </div>
            <div style="text-align: right;">
                <button class="btn btn-secondary" id="cancelImageBtn">取消</button>
                <button class="btn btn-primary" id="saveImageBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 密码修改模态框 -->
<div class="modal" id="passwordModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">修改访问密码</h3>
            <button class="close-modal" id="closePasswordModal">&times;</button>
        </div>
        <div id="passwordModalBody">
            <div class="form-group">
                <label for="currentPassword">当前密码</label>
                <input type="password" id="currentPassword" class="form-control" placeholder="请输入当前密码">
            </div>
            <div class="form-group">
                <label for="newPassword">新密码</label>
                <input type="password" id="newPassword" class="form-control" placeholder="请输入新密码">
            </div>
            <div class="form-group">
                <label for="confirmPassword">确认新密码</label>
                <input type="password" id="confirmPassword" class="form-control" placeholder="请再次输入新密码">
            </div>
            <div style="text-align: right;">
                <button class="btn btn-secondary" id="cancelPasswordBtn">取消</button>
                <button class="btn btn-primary" id="savePasswordBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 全局数据存储
    let appData = {
        // 网站基本信息
        siteTitle: "芬与萌的甜蜜空间",
        coupleName: "芬与萌的甜蜜空间",
        tagline: "这里记录着我们每一个甜蜜瞬间，从游戏世界的初遇到现实生活的相爱，每一个回忆都值得珍藏。这是我们专属的小天地，只属于我们两个人的故事。",
        footerText: "© 2025 芬与萌的甜蜜空间 | 游戏中的<span class='heartbeat'>饭饭</span>与<span class='heartbeat'>南書</span>，现实中的<span class='heartbeat'>芬</span>与<span class='heartbeat'>萌</span>",
        footerQuote: "每一天都因为有你而更加美好 ❤️",

        // 首页照片
        homePhotos: [
            {
                id: 1,
                url: "https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=687&q=80",
                title: "想象中的海边",
                description: "芬说她想去看海，这是我们未来要去的海边"
            },
            {
                id: 2,
                url: "https://images.unsplash.com/photo-1539635278303-d4002c07eae3?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80",
                title: "游戏中的约定",
                description: "在游戏中相遇的我们，有了特别的约定"
            },
            {
                id: 3,
                url: "https://images.unsplash.com/photo-1542037104857-ffbb0b9155fb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80",
                title: "甜蜜日常",
                description: "想象中我们一起的日常生活"
            }
        ],

        // 关于她的信息
        aboutHer: {
            basicInfo: [
                { label: "生日", value: "2003年4月23日" },
                { label: "家乡", value: "江西赣州" },
                { label: "游戏名字", value: "茶泡饭、饭饭、冷" },
                { label: "我的游戏名字", value: "南書" },
                { label: "饮食习惯", value: "家里准时准点吃饭（中午12点，晚上18点）" },
                { label: "天气偏好", value: "喜欢多云，不喜欢下雨天（泥土的味道）" },
                { label: "早餐习惯", value: "几乎不吃早餐" }
            ],
            likes: [
                { label: "明星", value: "白鹿、肖战" },
                { label: "喜欢的茶", value: "古茗的云岭茉莉白" },
                { label: "最喜欢的食物", value: "螺蛳粉" },
                { label: "想去的地方", value: "海边" },
                { label: "性格偏好", value: "喜欢偏执，只要一人；喜欢需要；喜欢在乎；喜欢独一无二" },
                { label: "游戏相遇", value: "2025年4月6日，在游戏中认识了叫'茶泡饭'的女孩" }
            ],
            dislikes: [
                { label: "影视题材", value: "不喜欢骨科题材" },
                { label: "感情上", value: "不喜欢精神出轨" },
                { label: "食物甜度", value: "不喜欢吃太甜的" },
                { label: "肉类", value: "不喜欢吃肉" },
                { label: "节日食物", value: "不喜欢月饼" },
                { label: "蔬菜", value: "不喜欢生的番茄" }
            ],
            timeline: [
                {
                    date: "2025年4月6日",
                    title: "初遇·茶泡饭",
                    content: "游戏中相识，她叫'茶泡饭'，我以为她是说茶不一样要贵点，没想到是自我介绍。她说：'你知道吗？我是茶泡饭'，我回答：'哦？想收我多少？' 她说：'嘿嘿我的茶一杯500，但对你免费'，我回答：'好巧，我好友位收费，但对你例外。'"
                },
                {
                    date: "2025年5月27日",
                    title: "在一起",
                    content: "今天我鼓起勇气问她：'你喜欢我吗？' 她的回答让我心跳加速：'喜欢啊，不喜欢为什么靠近你？为什么还留在你身边这么久？我不喜欢早就走了。' 我让她当我的唯一，她答应了。从今天起，茶泡饭和南書正式在一起了！"
                }
            ]
        },

        // 日记 - 增强版，包含图片附件
        diaries: [
            {
                id: 1,
                date: '2025-04-06',
                title: '初遇茶泡饭',
                content: '今天在游戏中认识了一个叫"茶泡饭"的女孩。她告诉我："你知道吗？我是茶泡饭"。我以为她是在说自己的茶不一样，要贵点，没想到是自我介绍。她说她的茶一杯500，但对我免费。我开玩笑说我的好友位收费，但对她例外。就这样，我们开始了特别的对话。<br><br>她问我为什么对她例外，我说想听真话还是假话，她贪心地说都想听。我回答："你人好，顺眼；你茶香，好喝。" 她问哪句是真话，我说你猜猜看，她自恋地猜第一句。她猜对了，这个聪明的女孩。',
                mood: '😊',
                images: [
                    "https://images.unsplash.com/photo-1550745165-9bc0b252726f?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80"
                ],
                tags: ['游戏', '初遇', '饭饭', '南書'],
                isDraft: false
            },
            {
                id: 2,
                date: '2025-04-10',
                title: '第一次语音聊天',
                content: '今天和饭饭第一次语音聊天，她的声音真好听。我们聊了很多，从游戏到生活。她告诉我她喜欢古茗的云岭茉莉白，不喜欢吃太甜的东西，也不喜欢吃肉。<br><br>她来自江西赣州，家里准时准点吃饭，中午12点，晚上18点。她喜欢多云，不喜欢下雨天因为会有泥土的味道。她几乎不吃早餐，这让我有点担心她的健康。<br><br>她还告诉我她喜欢偏执，只要一人；喜欢需要；喜欢在乎；喜欢独一无二。这让我更加喜欢她了。',
                mood: '🥰',
                images: [
                    "https://images.unsplash.com/photo-1511795409834-ef04bbd61622?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80"
                ],
                tags: ['语音', '了解', '饭饭'],
                isDraft: false
            },
            {
                id: 3,
                date: '2025-05-27',
                title: '我们在一起了',
                content: '<strong>今天我鼓起勇气问她："你喜欢我吗？"</strong> 她的回答让我心跳加速："喜欢啊，不喜欢为什么靠近你？为什么还留在你身边这么久？我不喜欢早就走了。" 我让她当我的唯一，她答应了。<br><br>从今天起，茶泡饭和南書正式在一起了！在游戏里我们是饭饭和南書，在现实中我们是芬和萌。<br><br>她生日是2003年4月23日，喜欢白鹿和肖战，最喜欢吃螺蛳粉，想去海边。她不喜欢骨科题材，不喜欢精神出轨，不喜欢吃太甜的，不喜欢肉，不喜欢月饼，不喜欢生的番茄。<br><br>我要记住她所有的喜好和不喜欢，好好珍惜她。',
                mood: '😍',
                images: [
                    "https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
                    "https://images.unsplash.com/photo-1542037104857-ffbb0b9155fb?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80"
                ],
                tags: ['在一起', '纪念', '芬', '萌'],
                isDraft: false
            }
        ],

        // 相册
        galleryAlbums: [
            {
                id: 1,
                name: '游戏回忆',
                photoCount: 5,
                cover: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1170&q=80',
                description: '游戏中的美好回忆',
                tags: ['游戏', '饭饭', '南書']
            },
            {
                id: 2,
                name: '芬的喜好',
                photoCount: 8,
                cover: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?ixlib=rb-4.0.3&auto=format&fit=crop&w=1081&q=80',
                description: '芬喜欢的东西',
                tags: ['芬', '喜好', '现实']
            },
            {
                id: 3,
                name: '想象中的约会',
                photoCount: 6,
                cover: 'https://images.unsplash.com/photo-1511795409834-ef04bbd61622?ixlib=rb-4.0.3&auto=format&fit=crop&w=1169&q=80',
                description: '未来想和芬一起去的地方',
                tags: ['未来', '约会', '芬', '萌']
            }
        ],

        // 纪念日 - 完全按照要求
        milestones: [
            {
                id: 1,
                title: '在一起纪念',
                dateType: 'since',
                targetDate: '2025-05-27',
                icon: 'fas fa-heart',
                showDays: true,
                showHours: true,
                showMinutes: true,
                isYearly: true,
                description: '从2025年5月27日我们在一起开始计算'
            },
            {
                id: 2,
                title: '芬的生日（出生至今）',
                dateType: 'since',
                targetDate: '2003-04-23',
                icon: 'fas fa-birthday-cake',
                showDays: true,
                showHours: true,
                showMinutes: false,
                isYearly: false,
                description: '芬从出生到现在的时间'
            },
            {
                id: 3,
                title: '芬的下一个生日',
                dateType: 'until',
                targetDate: '2003-04-23',
                icon: 'fas fa-gift',
                showDays: true,
                showHours: true,
                showMinutes: true,
                isYearly: true,
                description: '距离芬的下一个生日还有'
            },
            {
                id: 4,
                title: '初遇纪念',
                dateType: 'since',
                targetDate: '2025-04-06',
                icon: 'fas fa-gamepad',
                showDays: true,
                showHours: true,
                showMinutes: false,
                isYearly: true,
                description: '从2025年4月6日初遇开始计算'
            }
        ],
        
        // ===== 新增：特别功能数据 =====
        // 恋爱温度
        loveTemperature: 36.5,
        temperatureMessages: [
            "今天温度正常，继续保持哦！",
            "暖暖的很贴心~",
            "温度上升中，爱情在升温！",
            "热恋模式已开启！",
            "今天有点凉爽，需要加加温~"
        ],
        
        // 重要日期
        importantDates: [
            { name: "芬的生日", date: "2003-04-23", icon: "🎂", description: "芬的生日" },
            { name: "情人节", date: "2026-02-14", icon: "❤️", description: "情人节" },
            { name: "恋爱100天", date: "2025-09-04", icon: "💕", description: "在一起100天纪念" },
            { name: "圣诞节", date: "2025-12-25", icon: "🎄", description: "圣诞节" },
            { name: "七夕", date: "2025-08-29", icon: "🎋", description: "七夕情人节" }
        ],
        
        // 音乐播放列表
        musicPlaylist: [
            { title: "我们的爱", artist: "专属旋律", src: "" },
            { title: "甜蜜蜜", artist: "邓丽君", src: "" },
            { title: "简单爱", artist: "周杰伦", src: "" },
            { title: "因为爱情", artist: "王菲/陈奕迅", src: "" },
            { title: "最浪漫的事", artist: "赵咏华", src: "" }
        ],
        
        // 每日情话
        dailyLoveMessages: [
            "我爱你，不是因为你是一个怎样的人，而是因为我喜欢与你在一起时的感觉。",
            "遇见你是我此生最美的意外。",
            "有你在身边，每一天都闪闪发光。",
            "爱你不是选择，而是必然。",
            "你是我藏在云层里的月亮，也是我穷极一生的宝藏。",
            "我想和你，从天光乍破，走到暮雪白头。",
            "世界那么大，我只想和你在一起。",
            "你是我疲惫生活中的英雄梦想。",
            "遇见你，是我人生中最美好的事情。",
            "爱你，是我做过最正确的事。"
        ],
        
        // 记忆相册
        memoryPhotos: [
            "https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
            "https://images.unsplash.com/photo-1550745165-9bc0b252726f?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
            "https://images.unsplash.com/photo-1511795409834-ef04bbd61622?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
            "https://images.unsplash.com/photo-1542037104857-ffbb0b9155fb?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
            "https://images.unsplash.com/photo-1539635278303-d4002c07eae3?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80"
        ],

        // ID计数器
        nextDiaryId: 4,
        nextPhotoId: 4,
        nextMilestoneId: 5,

        // 当前编辑状态
        currentDiaryId: null,
        editingItem: null,

        // 网站密码 - 默认密码
        sitePassword: "250406250527",

        // 所有标签集合
        allTags: []
    };

    // 调试模式
    let debugMode = false;
    let autoSaveInterval;
    let currentFilterTag = null;
    let currentSearchQuery = '';
    let isMusicPlaying = false;
    let currentSongIndex = 0;
    let lastSurpriseDate = null;

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        console.log("页面加载完成，开始初始化...");

        // 创建浮动爱心
        createFloatingHearts();

        // 从本地存储加载数据
        loadDataFromStorage();

        // 初始化密码保护
        initPasswordProtection();

        // 初始化其他功能（但先不显示网站内容）
        initExportFunctions();
        initSettingsButtons();
        initNavigation();
        initHomePage();
        initAboutHerPage();
        initDiary();
        initGallery();
        initMilestones();
        initModals();
        initEditButtons();
        initSpecialFeatures();

        // 设置当前日期
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('diaryDate').value = today;

        // 更新纪念日倒计时/正计时
        updateMilestoneCounters();
        updateDualCountdown();

        // 每分钟更新一次纪念日
        setInterval(updateMilestoneCounters, 60000);
        setInterval(updateDualCountdown, 60000);

        // 每30秒自动保存一次
        setInterval(saveDataToStorage, 30000);

        // 显示调试信息
        updateDebugInfo();

        // 初始化自动保存功能
        initAutoSave();

        // 加载留言
        loadNotesFromLocal();

        console.log("初始化完成，等待密码验证...");
    });

    // ===== 新增：初始化特别功能 =====
    function initSpecialFeatures() {
        // 初始化温度计
        updateTemperature();
        
        // 初始化重要日期列表
        updateImportantDatesList();
        
        // 初始化音乐播放器
        initMusicPlayer();
        
        // 初始化记忆相册
        updateMemoryGallery();
        
        // 初始化每日情话
        updateDailyLoveMessage();
        
        // 添加导航菜单项
        const mainMenu = document.getElementById('mainMenu');
        if (mainMenu) {
            // 检查是否已存在特别功能菜单项
            let specialFeaturesExists = false;
            mainMenu.querySelectorAll('li').forEach(li => {
                if (li.textContent.includes('特别功能')) {
                    specialFeaturesExists = true;
                }
            });
            
            if (!specialFeaturesExists) {
                const specialFeaturesItem = document.createElement('li');
                specialFeaturesItem.innerHTML = '<a href="#" class="nav-link" data-section="special-features">特别功能</a>';
                mainMenu.appendChild(specialFeaturesItem);
            }
            
            // 重新绑定所有导航链接的事件监听
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                // 移除可能存在的重复事件监听
                link.removeEventListener('click', handleNavClick);
                link.addEventListener('click', handleNavClick);
            });
        }
    }

    // 导航点击处理函数
    function handleNavClick(e) {
        e.preventDefault();
        
        // 获取目标部分
        const targetSection = this.getAttribute('data-section');
        
        // 更新活动链接
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => link.classList.remove('active'));
        this.classList.add('active');
        
        // 显示目标部分
        const sections = document.querySelectorAll('.section');
        sections.forEach(section => {
            section.classList.remove('active');
            section.style.display = 'none';
        });
        
        // 显示选中的部分
        const targetElement = document.getElementById(targetSection);
        if (targetElement) {
            targetElement.style.display = 'block';
            targetElement.classList.add('active');
            // 添加淡入效果
            targetElement.style.animation = 'fadeIn 0.5s ease forwards';
        }
        
        // 如果是特别功能页面，更新内容
        if (targetSection === 'special-features') {
            updateImportantDatesList();
            updateDailyLoveMessage();
        }
        
        // 移动端菜单隐藏
        const mainMenu = document.getElementById('mainMenu');
        if (window.innerWidth <= 768 && mainMenu) {
            mainMenu.classList.remove('show');
        }
    }

    // ===== 新增：更新双计时显示 =====
    function updateDualCountdown() {
        // 纪念日设置
        const anniversaryDate = new Date('2025-05-27'); // 在一起的日子
        const now = new Date();
        
        // 计算已经在一起的天数（正计时）
        const timeTogether = now - anniversaryDate;
        const daysTogether = Math.floor(timeTogether / (1000 * 60 * 60 * 24));
        const hoursTogether = Math.floor((timeTogether % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutesTogether = Math.floor((timeTogether % (1000 * 60 * 60)) / (1000 * 60));
        const monthsTogether = Math.floor(daysTogether / 30);
        
        // 更新正计时显示
        if (document.getElementById('days-together')) {
            document.getElementById('days-together').textContent = daysTogether.toLocaleString();
        }
        if (document.getElementById('months-together')) {
            document.getElementById('months-together').textContent = monthsTogether;
        }
        if (document.getElementById('hours-together')) {
            document.getElementById('hours-together').textContent = hoursTogether;
        }
        if (document.getElementById('minutes-together')) {
            document.getElementById('minutes-together').textContent = minutesTogether;
        }
        
        // 计算距离下一个纪念日（周年）的天数
        let nextAnniversary = new Date(anniversaryDate);
        nextAnniversary.setFullYear(now.getFullYear());
        
        if (nextAnniversary < now) {
            nextAnniversary.setFullYear(nextAnniversary.getFullYear() + 1);
        }
        
        const timeRemaining = nextAnniversary - now;
        const daysRemaining = Math.ceil(timeRemaining / (1000 * 60 * 60 * 24));
        const weeksRemaining = Math.floor(daysRemaining / 7);
        const hoursRemaining = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutesRemaining = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
        
        // 更新倒计时显示
        if (document.getElementById('days-remaining')) {
            document.getElementById('days-remaining').textContent = daysRemaining;
        }
        if (document.getElementById('weeks-remaining')) {
            document.getElementById('weeks-remaining').textContent = weeksRemaining;
        }
        if (document.getElementById('hours-remaining')) {
            document.getElementById('hours-remaining').textContent = hoursRemaining;
        }
        if (document.getElementById('minutes-remaining')) {
            document.getElementById('minutes-remaining').textContent = minutesRemaining;
        }
        
        // 更新日期显示
        if (document.getElementById('anniversary-date-display')) {
            document.getElementById('anniversary-date-display').textContent = formatDate(anniversaryDate);
        }
        if (document.getElementById('next-anniversary-date')) {
            document.getElementById('next-anniversary-date').textContent = formatDate(nextAnniversary);
        }
        
        // 更新进度条
        updateProgressBars(now, daysTogether, daysRemaining);
        
        // 更新下一个重要日子
        updateNextSpecialDay(now);
    }
    
    function updateProgressBars(now, daysTogether, daysRemaining) {
        // 今年已经过去的天数百分比
        const startOfYear = new Date(now.getFullYear(), 0, 1);
        const endOfYear = new Date(now.getFullYear() + 1, 0, 1);
        const yearProgress = ((now - startOfYear) / (endOfYear - startOfYear)) * 100;
        
        const yearProgressElement = document.getElementById('year-progress');
        const yearProgressText = document.getElementById('year-progress-text');
        if (yearProgressElement && yearProgressText) {
            yearProgressElement.style.width = `${yearProgress}%`;
            yearProgressText.textContent = `${yearProgress.toFixed(1)}%`;
        }
        
        // 周年进度（从上次纪念日到现在）
        const daysInCycle = daysTogether + daysRemaining;
        const anniversaryProgress = (daysTogether / daysInCycle) * 100;
        
        const anniversaryProgressElement = document.getElementById('anniversary-progress');
        const anniversaryProgressText = document.getElementById('anniversary-progress-text');
        if (anniversaryProgressElement && anniversaryProgressText) {
            anniversaryProgressElement.style.width = `${anniversaryProgress}%`;
            anniversaryProgressText.textContent = `${anniversaryProgress.toFixed(1)}%`;
        }
    }
    
    function updateNextSpecialDay(now) {
        const specialDays = [
            { name: '芬的生日', date: new Date('2003-04-23'), emoji: '🎂' },
            { name: '情人节', date: new Date(now.getFullYear(), 1, 14), emoji: '❤️' },
            { name: '七夕节', date: new Date(now.getFullYear(), 7, 29), emoji: '🎋' },
            { name: '圣诞节', date: new Date(now.getFullYear(), 11, 25), emoji: '🎄' },
            { name: '元旦', date: new Date(now.getFullYear() + 1, 0, 1), emoji: '🎉' }
        ];
        
        let closestDay = null;
        let minDays = Infinity;
        
        specialDays.forEach(day => {
            // 如果日期已经过去，设置为下一年
            const dateThisYear = new Date(day.date);
            if (dateThisYear < now) {
                dateThisYear.setFullYear(dateThisYear.getFullYear() + 1);
            }
            
            const daysDiff = Math.ceil((dateThisYear - now) / (1000 * 60 * 60 * 24));
            
            if (daysDiff < minDays) {
                minDays = daysDiff;
                closestDay = { ...day, date: dateThisYear, days: daysDiff };
            }
        });
        
        const nextSpecialDayElement = document.getElementById('next-special-day');
        const nextEventDateElement = document.getElementById('next-event-date');
        
        if (closestDay && nextSpecialDayElement && nextEventDateElement) {
            const displayDate = formatDate(closestDay.date);
            nextSpecialDayElement.innerHTML = 
                `${closestDay.emoji} <strong>${closestDay.name}</strong> - ${displayDate}`;
            nextEventDateElement.innerHTML = 
                `还有 <span style="color: var(--primary-pink); font-weight: 700;">${closestDay.days}</span> 天`;
        }
    }
    
    function formatDate(date) {
        return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
    }

    // ===== 新增：恋爱温度计功能 =====
    function updateTemperature() {
        const tempValue = appData.loveTemperature;
        const mercury = document.getElementById('temperature-mercury');
        const valueDisplay = document.getElementById('temperature-value');
        const messageDisplay = document.getElementById('temperature-message');
        
        if (!mercury || !valueDisplay || !messageDisplay) return;
        
        // 计算水银高度 (0-100度对应0-260px)
        const mercuryHeight = (tempValue / 100) * 260;
        mercury.style.height = `${mercuryHeight}px`;
        
        // 更新温度值
        valueDisplay.textContent = `${tempValue.toFixed(1)}°`;
        
        // 更新温度消息
        let message = '';
        if (tempValue >= 90) {
            message = "🔥 热恋沸腾！爱意满满！";
            valueDisplay.style.color = "#ff0000";
        } else if (tempValue >= 75) {
            message = "❤️ 温暖甜蜜，持续升温中！";
            valueDisplay.style.color = "#ff5500";
        } else if (tempValue >= 50) {
            message = "💖 稳定温暖，平平淡淡才是真~";
            valueDisplay.style.color = "#ff9900";
        } else if (tempValue >= 36) {
            message = "💗 温度正常，继续保持哦！";
            valueDisplay.style.color = "#00aa00";
        } else {
            message = "💙 有点凉爽，需要加加温~";
            valueDisplay.style.color = "#0088ff";
        }
        
        messageDisplay.textContent = message;
    }
    
    function increaseTemperature() {
        if (appData.loveTemperature < 100) {
            appData.loveTemperature = Math.min(100, appData.loveTemperature + 2.5);
            updateTemperature();
            
            // 添加动画效果
            const valueDisplay = document.getElementById('temperature-value');
            if (valueDisplay) {
                valueDisplay.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    valueDisplay.style.transform = 'scale(1)';
                }, 300);
            }
            
            saveDataToStorage();
        } else {
            alert('温度已经爆表啦！❤️‍🔥');
        }
    }
    
    function sendLoveMessage() {
        const messages = [
            "今天特别想你！",
            "你是我生命中最美的遇见 💖",
            "每分每秒都想和你在一起",
            "爱你是我做过最正确的事",
            "你是我的小太阳 🌟",
            "有你在的每一天都是晴天 ☀️",
            "想牵你的手，走过每一个春夏秋冬",
            "你笑起来真好看，像春天的花一样",
            "我的世界因为有你而完整",
            "爱你不是一时兴起，而是深思熟虑"
        ];
        
        const randomMessage = messages[Math.floor(Math.random() * messages.length)];
        
        // 显示消息
        const messageDisplay = document.getElementById('temperature-message');
        if (messageDisplay) {
            messageDisplay.innerHTML = `<span style="color: #FF1493;">💌 "${randomMessage}" 💌</span>`;
            
            // 温度小幅上升
            if (appData.loveTemperature < 100) {
                appData.loveTemperature = Math.min(100, appData.loveTemperature + 0.5);
                updateTemperature();
            }
            
            // 添加心跳动画
            messageDisplay.style.animation = 'none';
            setTimeout(() => {
                messageDisplay.style.animation = 'heartbeat 0.8s';
            }, 10);
            
            // 3秒后恢复
            setTimeout(() => {
                updateTemperature();
            }, 3000);
        }
    }

    // ===== 新增：重要日期功能 =====
    function updateImportantDatesList() {
        const container = document.getElementById('important-dates-list');
        if (!container) return;
        
        container.innerHTML = '';
        
        const now = new Date();
        appData.importantDates.forEach(date => {
            const dateObj = new Date(date.date);
            let daysDiff = Math.ceil((dateObj - now) / (1000 * 60 * 60 * 24));
            let whenText = '';
            
            if (daysDiff === 0) {
                whenText = '今天';
            } else if (daysDiff === 1) {
                whenText = '明天';
            } else if (daysDiff < 0) {
                whenText = '已过去';
                daysDiff = Math.abs(daysDiff);
            } else {
                whenText = `${daysDiff}天后`;
            }
            
            const dateItem = document.createElement('div');
            dateItem.className = 'date-item';
            dateItem.innerHTML = `
                <div>
                    <span class="date-icon">${date.icon}</span>
                </div>
                <div class="date-content">
                    <div class="date-name">${date.name}</div>
                    <div class="date-when">${date.description}</div>
                </div>
                <div class="date-countdown">${whenText}</div>
            `;
            
            container.appendChild(dateItem);
        });
    }
    
    function addImportantDate() {
        const name = prompt('请输入日期名称（如：相遇纪念日）:');
        if (!name) return;
        
        const dateStr = prompt('请输入日期（格式：YYYY-MM-DD，如：2025-08-20）:');
        if (!dateStr) return;
        
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) {
            alert('日期格式不正确！');
            return;
        }
        
        const description = prompt('请输入日期描述:');
        const icon = prompt('请输入图标emoji（如：🎂、❤️、🎁）:', '🎁');
        
        appData.importantDates.push({
            name,
            date: dateStr,
            icon,
            description: description || ''
        });
        
        saveDataToStorage();
        updateImportantDatesList();
        alert('重要日期添加成功！');
    }

    // ===== 新增：音乐播放器功能 =====
    function initMusicPlayer() {
        const playBtn = document.getElementById('play-btn');
        const songSelector = document.getElementById('song-selector');
        
        if (playBtn) {
            playBtn.addEventListener('click', toggleMusic);
        }
        
        if (songSelector) {
            songSelector.addEventListener('change', function() {
                currentSongIndex = parseInt(this.value);
                updateSongInfo();
            });
        }
        
        updateSongInfo();
    }
    
    function toggleMusic() {
        const playBtn = document.getElementById('play-btn');
        
        if (!playBtn) return;
        
        if (isMusicPlaying) {
            // 停止音乐
            playBtn.innerHTML = '<i class="fas fa-play"></i>';
            playBtn.style.background = 'white';
            playBtn.style.color = 'var(--primary-pink)';
            
            // 停止动画
            const songTitle = document.getElementById('current-song');
            if (songTitle) {
                songTitle.style.animation = '';
            }
        } else {
            // 播放音乐
            playBtn.innerHTML = '<i class="fas fa-pause"></i>';
            playBtn.style.background = 'var(--primary-pink)';
            playBtn.style.color = 'white';
            
            // 模拟播放效果
            const songTitle = document.getElementById('current-song');
            if (songTitle) {
                songTitle.style.animation = 'heartbeat 1s infinite';
            }
        }
        
        isMusicPlaying = !isMusicPlaying;
    }
    
    function updateSongInfo() {
        const songTitle = document.getElementById('current-song');
        const songArtist = document.getElementById('current-artist');
        
        if (!songTitle || !songArtist) return;
        
        const song = appData.musicPlaylist[currentSongIndex];
        if (song) {
            songTitle.textContent = song.title;
            songArtist.textContent = song.artist;
        }
    }
    
    function addCustomSong() {
        const title = prompt('请输入歌曲名称:');
        if (!title) return;
        
        const artist = prompt('请输入歌手名称:');
        
        appData.musicPlaylist.push({
            title,
            artist,
            src: ''
        });
        
        // 更新选择器
        const songSelector = document.getElementById('song-selector');
        if (songSelector) {
            const option = document.createElement('option');
            option.value = appData.musicPlaylist.length - 1;
            option.textContent = `🎵 ${title} - ${artist}`;
            songSelector.appendChild(option);
        }
        
        saveDataToStorage();
        alert('歌曲添加成功！');
    }

    // ===== 新增：惊喜盒子功能 =====
    function openSurprise() {
        const today = new Date().toDateString();
        
        // 检查今天是否已经打开过
        if (lastSurpriseDate === today) {
            alert('今天的惊喜已经打开过了，明天再来吧！');
            return;
        }
        
        // 更新最后打开日期
        lastSurpriseDate = today;
        localStorage.setItem('lastSurpriseDate', today);
        
        // 随机选择一个情话
        const randomMessage = appData.dailyLoveMessages[
            Math.floor(Math.random() * appData.dailyLoveMessages.length)
        ];
        
        // 显示情话
        const dailyLoveMessage = document.getElementById('daily-love-message');
        if (dailyLoveMessage) {
            dailyLoveMessage.textContent = randomMessage;
        }
        
        // 添加动画效果
        const surpriseBox = document.querySelector('.surprise-box');
        if (surpriseBox) {
            surpriseBox.style.transform = 'scale(1.05)';
            setTimeout(() => {
                surpriseBox.style.transform = 'scale(1)';
            }, 300);
        }
        
        // 显示提示
        setTimeout(() => {
            alert('今日情话已更新！💖');
        }, 500);
    }
    
    function updateDailyLoveMessage() {
        // 从本地存储获取最后打开日期
        lastSurpriseDate = localStorage.getItem('lastSurpriseDate');
        
        // 如果今天已经打开过，显示昨天的情话
        const today = new Date().toDateString();
        const dailyLoveMessage = document.getElementById('daily-love-message');
        
        if (dailyLoveMessage) {
            if (lastSurpriseDate === today) {
                // 这里可以显示特定的情话
                const randomMessage = appData.dailyLoveMessages[
                    Math.floor(Math.random() * appData.dailyLoveMessages.length)
                ];
                dailyLoveMessage.textContent = randomMessage;
            }
        }
    }

    // ===== 新增：记忆相册功能 =====
    function updateMemoryGallery() {
        const gallery = document.getElementById('memory-gallery');
        if (!gallery) return;
        
        gallery.innerHTML = '';
        
        appData.memoryPhotos.forEach(photo => {
            const img = document.createElement('img');
            img.src = photo;
            img.alt = '甜蜜记忆';
            img.title = '点击查看大图';
            img.onclick = () => viewImage(photo);
            gallery.appendChild(img);
        });
    }
    
    function viewMemoryGallery() {
        // 这里可以扩展为全屏相册查看器
        alert('记忆相册功能已开启！可以浏览我们所有的甜蜜瞬间。');
    }
    
    function uploadMemoryPhoto() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    appData.memoryPhotos.unshift(e.target.result);
                    saveDataToStorage();
                    updateMemoryGallery();
                    alert('照片已添加到记忆相册！');
                };
                reader.readAsDataURL(file);
            }
        };
        
        input.click();
    }

    // ===== 新增：恋爱测试功能 =====
    function startLoveQuiz() {
        const questions = [
            {
                question: "芬的生日是什么时候？",
                options: ["2003年4月23日", "2002年5月15日", "2003年3月20日", "2004年1月10日"],
                answer: 0
            },
            {
                question: "芬最喜欢喝什么茶？",
                options: ["古茗的云岭茉莉白", "珍珠奶茶", "乌龙茶", "红茶"],
                answer: 0
            },
            {
                question: "我们是在哪一天相遇的？",
                options: ["2025年4月6日", "2025年3月15日", "2025年5月20日", "2025年6月1日"],
                answer: 0
            },
            {
                question: "芬不喜欢吃什么？",
                options: ["肉", "蔬菜", "水果", "米饭"],
                answer: 0
            },
            {
                question: "我们是在哪一天在一起的？",
                options: ["2025年5月27日", "2025年4月6日", "2025年6月1日", "2025年7月7日"],
                answer: 0
            }
        ];
        
        let score = 0;
        let currentQuestion = 0;
        
        function askQuestion() {
            if (currentQuestion >= questions.length) {
                showResult();
                return;
            }
            
            const q = questions[currentQuestion];
            let response = prompt(
                `问题 ${currentQuestion + 1}/${questions.length}\n\n` +
                `${q.question}\n\n` +
                q.options.map((opt, i) => `${i + 1}. ${opt}`).join('\n') +
                '\n\n请输入选项数字:'
            );
            
            if (response === null) return; // 用户取消了
            
            const answerIndex = parseInt(response) - 1;
            if (answerIndex === q.answer) {
                score++;
                alert('回答正确！💖');
            } else {
                alert(`回答错误！正确答案是：${q.options[q.answer]}`);
            }
            
            currentQuestion++;
            askQuestion();
        }
        
        function showResult() {
            const percentage = (score / questions.length) * 100;
            let message = '';
            
            if (percentage === 100) {
                message = "太棒了！你对芬的了解满分！🎉";
            } else if (percentage >= 80) {
                message = "很好！你对芬的了解很深入！💕";
            } else if (percentage >= 60) {
                message = "还不错！但还可以更了解她哦~";
            } else {
                message = "需要多花时间了解芬哦，爱需要用心~";
            }
            
            alert(`测试完成！\n\n你的得分: ${score}/${questions.length} (${percentage}%)\n\n${message}`);
        }
        
        askQuestion();
    }

    // ===== 新增：爱的留言板功能 =====
    function addLoveNote() {
        const textarea = document.getElementById('love-note');
        const message = textarea.value.trim();
        
        if (!message) {
            alert('请先写下你想说的话~');
            return;
        }
        
        const notesContainer = document.getElementById('notes-container');
        const noteDiv = document.createElement('div');
        
        const now = new Date();
        const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        
        noteDiv.className = 'date-item';
        noteDiv.style.marginBottom = '1rem';
        noteDiv.style.animation = 'fadeIn 0.5s';
        noteDiv.innerHTML = `
            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                <div style="width: 30px; height: 30px; background: linear-gradient(135deg, var(--primary-pink), var(--accent-color)); 
                     border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                    <i class="fas fa-heart" style="color: white; font-size: 0.8rem;"></i>
                </div>
                <div>
                    <strong>甜蜜留言</strong>
                    <small style="color: #888; margin-left: 10px;">${timeStr}</small>
                </div>
            </div>
            <div style="padding: 10px 0;">${message}</div>
        `;
        
        notesContainer.insertBefore(noteDiv, notesContainer.firstChild);
        textarea.value = '';
        
        // 保存到本地存储
        saveNoteToLocal(message, timeStr);
    }
    
    function saveNoteToLocal(message, time) {
        const notes = JSON.parse(localStorage.getItem('love-notes') || '[]');
        notes.unshift({ message, time, date: new Date().toISOString() });
        
        // 只保留最近的20条
        if (notes.length > 20) notes.length = 20;
        
        localStorage.setItem('love-notes', JSON.stringify(notes));
    }
    
    function loadNotesFromLocal() {
        const notes = JSON.parse(localStorage.getItem('love-notes') || '[]');
        const container = document.getElementById('notes-container');
        
        if (!container) return;
        
        container.innerHTML = '';
        
        notes.forEach(note => {
            const noteDiv = document.createElement('div');
            noteDiv.className = 'date-item';
            noteDiv.style.marginBottom = '1rem';
            noteDiv.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                    <div style="width: 30px; height: 30px; background: linear-gradient(135deg, var(--primary-pink), var(--accent-color)); 
                         border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                        <i class="fas fa-heart" style="color: white; font-size: 0.8rem;"></i>
                    </div>
                    <div>
                        <strong>甜蜜留言</strong>
                        <small style="color: #888; margin-left: 10px;">${note.time}</small>
                    </div>
                </div>
                <div style="padding: 10px 0;">${note.message}</div>
            `;
            container.appendChild(noteDiv);
        });
    }

    // 创建浮动爱心
    function createFloatingHearts() {
        const heartsContainer = document.getElementById('floating-hearts');
        if (!heartsContainer) return;
        
        for (let i = 0; i < 20; i++) {
            const heart = document.createElement('div');
            heart.className = 'floating-heart';
            heart.innerHTML = '<i class="fas fa-heart"></i>';
            heart.style.left = Math.random() * 100 + 'vw';
            heart.style.top = Math.random() * 100 + 'vh';
            heart.style.animationDelay = Math.random() * 15 + 's';
            heart.style.fontSize = (Math.random() * 1.5 + 1) + 'rem';
            heart.style.opacity = Math.random() * 0.5 + 0.3;
            heartsContainer.appendChild(heart);
        }
    }

    // 从本地存储加载数据
    function loadDataFromStorage() {
        try {
            const savedData = localStorage.getItem('sweetSpaceData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);

                // 深度合并数据，保留新添加的属性
                appData = deepMerge(appData, parsedData);

                // 确保ID计数器足够大
                appData.nextDiaryId = Math.max(appData.nextDiaryId, appData.diaries.length + 1);
                appData.nextPhotoId = Math.max(appData.nextPhotoId, appData.homePhotos.length + 1);
                appData.nextMilestoneId = Math.max(appData.nextMilestoneId, appData.milestones.length + 1);

                // 确保日记有images和tags字段（向后兼容）
                appData.diaries.forEach(diary => {
                    if (!diary.images) diary.images = [];
                    if (!diary.tags) diary.tags = [];
                    if (!diary.mood) diary.mood = '';
                });
                
                // 确保新增字段存在
                if (!appData.loveTemperature) appData.loveTemperature = 36.5;
                if (!appData.importantDates) appData.importantDates = [];
                if (!appData.musicPlaylist) appData.musicPlaylist = [];
                if (!appData.dailyLoveMessages) appData.dailyLoveMessages = [];
                if (!appData.memoryPhotos) appData.memoryPhotos = [];
            }

            // 检查是否有保存的密码
            const savedPassword = localStorage.getItem('sitePassword');
            if (savedPassword) {
                appData.sitePassword = savedPassword;
                console.log("从本地存储加载的密码:", savedPassword);
            } else {
                console.log("使用默认密码:", appData.sitePassword);
                // 如果没有保存的密码，使用默认密码
                appData.sitePassword = "250406250527";
                localStorage.setItem('sitePassword', appData.sitePassword);
            }

            // 更新标签集合
            updateAllTags();

            console.log('数据加载成功，日记数量:', appData.diaries.length);
            console.log('照片数量:', appData.homePhotos.length);
            console.log('纪念日数量:', appData.milestones.length);
        } catch (error) {
            console.error('加载数据时出错:', error);
            // 如果加载失败，重置为默认数据
            resetToDefaultData();
        }
    }

    // 更新所有标签集合
    function updateAllTags() {
        const allTags = new Set();
        appData.diaries.forEach(diary => {
            if (diary.tags && diary.tags.length > 0) {
                diary.tags.forEach(tag => allTags.add(tag));
            }
        });
        appData.allTags = Array.from(allTags);
    }

    // 重置为默认数据
    function resetToDefaultData() {
        console.log("重置为默认数据...");
        // 重置密码为默认值
        appData.sitePassword = "250406250527";
        // 保存默认数据
        saveDataToStorage();
    }

    // 深度合并对象
    function deepMerge(target, source) {
        for (let key in source) {
            if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                if (!target[key] || typeof target[key] !== 'object') {
                    target[key] = {};
                }
                deepMerge(target[key], source[key]);
            } else {
                target[key] = source[key];
            }
        }
        return target;
    }

    // 保存数据到本地存储
    function saveDataToStorage() {
        try {
            const dataToSave = JSON.stringify(appData);
            localStorage.setItem('sweetSpaceData', dataToSave);
            localStorage.setItem('sitePassword', appData.sitePassword);
            localStorage.setItem('lastSave', new Date().toISOString());

            console.log('数据保存成功，当前密码:', appData.sitePassword);

            // 显示自动保存提示
            showAutoSaveNotice();
        } catch (error) {
            console.error('保存数据时出错:', error);
        }
    }

    // 显示自动保存提示
    function showAutoSaveNotice() {
        const notice = document.getElementById('autoSaveNotice');
        if (notice) {
            notice.style.display = 'flex';
            setTimeout(() => {
                notice.style.display = 'none';
            }, 2000);
        }
    }

    // 初始化自动保存功能
    function initAutoSave() {
        // 监听日记内容变化
        const diaryContent = document.getElementById('diaryContent');
        const diaryTitle = document.getElementById('diaryTitle');

        if (diaryContent && diaryTitle) {
            // 防抖函数
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // 自动保存函数
            const autoSave = debounce(function() {
                if (appData.currentDiaryId) {
                    const diaryIndex = appData.diaries.findIndex(d => d.id === appData.currentDiaryId);
                    if (diaryIndex !== -1) {
                        // 更新日记内容
                        appData.diaries[diaryIndex].content = diaryContent.innerHTML;
                        appData.diaries[diaryIndex].title = diaryTitle.value;
                        appData.diaries[diaryIndex].isDraft = true;

                        // 保存到本地存储
                        saveDataToStorage();
                    }
                }
            }, 5000); // 5秒后自动保存

            // 监听输入事件
            diaryContent.addEventListener('input', autoSave);
            diaryTitle.addEventListener('input', autoSave);
        }
    }

    // 初始化密码保护
    function initPasswordProtection() {
        const passwordInput = document.getElementById('password-input');
        const passwordSubmit = document.getElementById('password-submit');
        const passwordError = document.getElementById('password-error');
        const emergencyAccess = document.getElementById('emergency-access');

        // 确保元素存在
        if (!passwordInput || !passwordSubmit) {
            console.error("密码输入框或提交按钮未找到");
            return;
        }

        console.log("初始化密码保护，密码为:", appData.sitePassword);
        console.log("提示：密码我们相遇和在一起的日期");

        // 密码输入框回车键提交
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // 密码提交按钮点击
        passwordSubmit.addEventListener('click', checkPassword);
        
        // 紧急访问按钮
        if (emergencyAccess) {
            emergencyAccess.addEventListener('click', function() {
                if (confirm('这将重置密码为默认值（250406250527），确定继续吗？')) {
                    // 重置密码
                    appData.sitePassword = "250406250527";
                    saveDataToStorage();
                    alert('密码已重置为默认值！现在可以使用密码 250406250527 登录。');
                    location.reload();
                }
            });
        }

        function checkPassword() {
            console.log("检查密码...");
            const inputPassword = passwordInput.value.trim();
            console.log("输入的密码:", inputPassword);
            console.log("正确密码:", appData.sitePassword);

            // 特殊调试密码
            if (inputPassword === "debug123") {
                console.log("调试模式激活！");
                debugMode = true;
                const debugInfo = document.getElementById('debugInfo');
                if (debugInfo) debugInfo.style.display = 'block';
                updateDebugInfo();
                showDebugMessage("调试模式已激活");
            }

            // 修复密码验证逻辑 - 简化验证
            const acceptedPasswords = [
                "250406250527",  // 默认密码
                "2025040620250527", // 详细日期
                "250406", // 相遇日期
                "250527", // 在一起日期
                appData.sitePassword // 存储的密码
            ];

            // 检查密码是否匹配
            const isPasswordValid = acceptedPasswords.includes(inputPassword);
            
            console.log("密码验证结果:", isPasswordValid, "接受的密码列表:", acceptedPasswords);

            if (isPasswordValid || inputPassword === "debug123") {
                console.log("密码正确，显示网站内容");

                // 如果输入的是默认密码但存储的密码不同，更新存储的密码
                if (inputPassword === "250406250527" && appData.sitePassword !== "250406250527") {
                    appData.sitePassword = "250406250527";
                    saveDataToStorage();
                    console.log("已更新密码为默认值");
                }

                // 密码正确，显示网站内容
                unlockSite();
            } else {
                // 密码错误
                console.log("密码错误");
                if (passwordError) {
                    passwordError.style.display = 'block';
                }
                passwordInput.value = '';
                passwordInput.focus();

                // 震动效果
                passwordInput.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    passwordInput.style.animation = '';
                }, 500);

                // 显示调试信息
                showDebugMessage(`密码错误！输入: "${inputPassword}"`);
            }
        }

        // 自动聚焦密码输入框
        setTimeout(() => {
            passwordInput.focus();
        }, 100);
    }
    
    // 解锁网站
    function unlockSite() {
        document.getElementById('password-protection').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('password-protection').style.display = 'none';
            document.getElementById('site-header').style.display = 'block';
            document.getElementById('site-content').style.display = 'block';
            document.getElementById('site-footer').style.display = 'block';
            document.getElementById('settingsPanel').style.display = 'flex';

            // 添加进入动画
            document.querySelectorAll('.section').forEach(section => {
                section.style.animation = 'fadeIn 0.8s ease forwards';
            });

            // 显示调试信息（如果调试模式激活）
            if (debugMode) {
                const debugInfo = document.getElementById('debugInfo');
                if (debugInfo) debugInfo.style.display = 'block';
            }
            
            // 确保首页显示
            const homeSection = document.getElementById('home');
            if (homeSection) {
                homeSection.style.display = 'block';
            }
        }, 500);
    }

    // 显示调试信息
    function updateDebugInfo() {
        if (!debugMode) return;

        const debugInfo = document.getElementById('debugInfo');
        if (debugInfo) {
            debugInfo.innerHTML = `
                当前密码: ${appData.sitePassword}<br>
                数据大小: ${JSON.stringify(appData).length} 字节<br>
                日记: ${appData.diaries.length} 篇<br>
                照片: ${appData.homePhotos.length} 张<br>
                纪念日: ${appData.milestones.length} 个
            `;
        }
    }

    // 显示调试消息
    function showDebugMessage(message) {
        if (!debugMode) return;

        console.log("调试消息:", message);
        const debugInfo = document.getElementById('debugInfo');
        if (debugInfo) {
            const oldContent = debugInfo.innerHTML;
            debugInfo.innerHTML = `${message}<br>${oldContent}`;

            // 3秒后清除消息
            setTimeout(() => {
                updateDebugInfo();
            }, 3000);
        }
    }

    // 初始化导出功能
    function initExportFunctions() {
        const exportBtn = document.getElementById('export-btn');
        const exportOptions = document.getElementById('export-options');
        const exportDiaryBtn = document.getElementById('export-diary');
        const exportAllBtn = document.getElementById('export-all');
        const exportPhotosBtn = document.getElementById('export-photos');

        if (!exportBtn) return;

        // 显示/隐藏导出选项
        exportBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (exportOptions) {
                exportOptions.classList.toggle('show');
            }
        });

        // 点击其他地方关闭导出选项
        document.addEventListener('click', function() {
            if (exportOptions) {
                exportOptions.classList.remove('show');
            }
        });

        // 导出日记
        if (exportDiaryBtn) {
            exportDiaryBtn.addEventListener('click', function() {
                exportDiaryData();
                if (exportOptions) exportOptions.classList.remove('show');
            });
        }

        // 导出所有数据
        if (exportAllBtn) {
            exportAllBtn.addEventListener('click', function() {
                exportAllData();
                if (exportOptions) exportOptions.classList.remove('show');
            });
        }

        // 导出照片链接
        if (exportPhotosBtn) {
            exportPhotosBtn.addEventListener('click', function() {
                exportPhotosData();
                if (exportOptions) exportOptions.classList.remove('show');
            });
        }
    }

    // 导出日记数据
    function exportDiaryData() {
        let exportText = "=== 芬与萌的恋爱日记 ===\\n\\n";

        appData.diaries.sort((a, b) => new Date(a.date) - new Date(b.date));

        appData.diaries.forEach(diary => {
            const date = new Date(diary.date);
            const formattedDate = `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日`;
            exportText += `【${formattedDate}】${diary.title} ${diary.mood || ''}\\n`;

            // 移除HTML标签，只保留文本
            const plainContent = diary.content.replace(/<[^>]*>/g, '');
            exportText += `${plainContent}\\n\\n`;

            // 图片链接
            if (diary.images && diary.images.length > 0) {
                exportText += `图片附件: ${diary.images.length} 张\\n`;
                diary.images.forEach((img, index) => {
                    exportText += `  ${index+1}. ${img}\\n`;
                });
                exportText += '\\n';
            }

            if (diary.tags && diary.tags.length > 0) {
                exportText += `标签: ${diary.tags.join(', ')}\\n`;
            }

            exportText += "─".repeat(50) + "\\n\\n";
        });

        downloadFile(exportText, '芬与萌的恋爱日记.txt', 'text/plain');
    }

    // 导出所有数据
    function exportAllData() {
        const exportData = {
            ...appData,
            // 不导出密码
            sitePassword: undefined
        };

        const exportText = JSON.stringify(exportData, null, 2);
        downloadFile(exportText, '芬与萌的甜蜜空间备份.json', 'application/json');
    }

    // 导出照片链接
    function exportPhotosData() {
        let exportText = "=== 芬与萌的照片记录 ===\\n\\n";

        // 首页照片
        exportText += "【首页照片】\\n";
        appData.homePhotos.forEach(photo => {
            exportText += `标题：${photo.title}\\n`;
            exportText += `描述：${photo.description}\\n`;
            exportText += `链接：${photo.url}\\n\\n`;
        });

        // 相册照片
        exportText += "\\n【相册照片】\\n";
        appData.galleryAlbums.forEach(album => {
            exportText += `相册：${album.name}\\n`;
            exportText += `描述：${album.description}\\n`;
            exportText += `照片数量：${album.photoCount}张\\n`;
            exportText += `封面：${album.cover}\\n`;

            if (album.tags && album.tags.length > 0) {
                exportText += `标签: ${album.tags.join(', ')}\\n`;
            }

            exportText += "\\n";
        });

        downloadFile(exportText, '芬与萌的照片记录.txt', 'text/plain');
    }

    // 下载文件函数
    function downloadFile(content, filename, contentType) {
        const blob = new Blob([content], { type: contentType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert(`文件 ${filename} 已开始下载！`);
    }

    // 初始化设置按钮
    function initSettingsButtons() {
        // 修改密码按钮
        const changePasswordBtn = document.getElementById('change-password-btn');
        if (changePasswordBtn) {
            changePasswordBtn.addEventListener('click', function() {
                openPasswordModal();
            });
        }

        // 备份数据按钮
        const backupBtn = document.getElementById('backup-btn');
        if (backupBtn) {
            backupBtn.addEventListener('click', function() {
                exportAllData();
                alert('数据备份已创建！');
            });
        }

        // 调试模式按钮
        const debugToggleBtn = document.getElementById('debug-toggle');
        if (debugToggleBtn) {
            debugToggleBtn.addEventListener('click', function() {
                debugMode = !debugMode;
                const debugInfo = document.getElementById('debugInfo');
                if (debugMode) {
                    if (debugInfo) debugInfo.style.display = 'block';
                    updateDebugInfo();
                    showDebugMessage("调试模式已激活");
                } else {
                    if (debugInfo) debugInfo.style.display = 'none';
                    showDebugMessage("调试模式已关闭");
                }
            });
        }
    }

    // 打开密码修改模态框
    function openPasswordModal() {
        const modal = document.getElementById('passwordModal');
        const currentPassword = document.getElementById('currentPassword');
        const newPassword = document.getElementById('newPassword');
        const confirmPassword = document.getElementById('confirmPassword');

        if (!modal || !currentPassword || !newPassword || !confirmPassword) return;

        // 清空表单
        currentPassword.value = '';
        newPassword.value = '';
        confirmPassword.value = '';

        modal.style.display = 'flex';
        currentPassword.focus();

        // 关闭按钮
        const closePasswordModal = document.getElementById('closePasswordModal');
        if (closePasswordModal) {
            closePasswordModal.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }

        // 取消按钮
        const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
        if (cancelPasswordBtn) {
            cancelPasswordBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }

        // 保存按钮
        const savePasswordBtn = document.getElementById('savePasswordBtn');
        if (savePasswordBtn) {
            savePasswordBtn.addEventListener('click', function() {
                const current = currentPassword.value.trim();
                const newPass = newPassword.value.trim();
                const confirm = confirmPassword.value.trim();

                if (current !== appData.sitePassword) {
                    alert('当前密码错误！');
                    return;
                }

                if (newPass.length < 6) {
                    alert('新密码至少需要6个字符！');
                    return;
                }

                if (newPass !== confirm) {
                    alert('两次输入的新密码不一致！');
                    return;
                }

                appData.sitePassword = newPass;
                saveDataToStorage();
                modal.style.display = 'none';
                alert('密码修改成功！');

                if (debugMode) {
                    showDebugMessage(`密码已修改为: ${newPass}`);
                }
            });
        }
    }

    // 初始化导航
    function initNavigation() {
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mainMenu = document.getElementById('mainMenu');

        // 导航菜单切换
        navLinks.forEach(link => {
            link.addEventListener('click', handleNavClick);
        });

        // 移动端菜单切换
        if (mobileMenuBtn && mainMenu) {
            mobileMenuBtn.addEventListener('click', function() {
                mainMenu.classList.toggle('show');
            });
        }
    }

    // 初始化首页
    function initHomePage() {
        // 设置网站标题
        const siteTitle = document.getElementById('site-title');
        const coupleNameText = document.getElementById('couple-name-text');
        const taglineText = document.getElementById('tagline-text');
        const footerText = document.getElementById('footer-text');
        const footerQuote = document.getElementById('footer-quote');
        
        if (siteTitle) siteTitle.textContent = appData.siteTitle;
        if (coupleNameText) coupleNameText.textContent = appData.coupleName;
        if (taglineText) taglineText.textContent = appData.tagline;
        if (footerText) footerText.innerHTML = appData.footerText;
        if (footerQuote) footerQuote.textContent = appData.footerQuote;

        // 加载首页照片
        loadHomePhotos();

        // 添加首页照片按钮
        const addHomePhotoBtn = document.getElementById('add-home-photo');
        if (addHomePhotoBtn) {
            addHomePhotoBtn.addEventListener('click', function() {
                openImageModal('home', null);
            });
        }
    }

    // 加载首页照片
    function loadHomePhotos() {
        const galleryContainer = document.getElementById('home-gallery');
        if (!galleryContainer) return;

        galleryContainer.innerHTML = '';

        if (appData.homePhotos.length === 0) {
            galleryContainer.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; background-color: rgba(255,255,255,0.7); border-radius: 15px;">
                    <i class="fas fa-images" style="font-size: 3rem; color: var(--primary-pink); margin-bottom: 20px;"></i>
                    <h3>还没有照片</h3>
                    <p>点击下方按钮添加你们的照片吧！</p>
                </div>
            `;
            return;
        }

        appData.homePhotos.forEach(photo => {
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            photoItem.dataset.id = photo.id;

            photoItem.innerHTML = `
                <img src="${photo.url}" alt="${photo.title}" onerror="this.src='https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?ixlib=rb-4.0.3&auto=format&fit=crop&w=687&q=80'">
                <div class="photo-caption">
                    <h3>${photo.title}</h3>
                    <p>${photo.description}</p>
                    <div style="margin-top: 10px;">
                        <button class="edit-btn edit-home-photo" data-id="${photo.id}" title="编辑照片">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn delete-home-photo" data-id="${photo.id}" title="删除照片">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            galleryContainer.appendChild(photoItem);
        });

        // 添加编辑和删除事件监听
        document.querySelectorAll('.edit-home-photo').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const photoId = parseInt(this.dataset.id);
                openImageModal('home', photoId);
            });
        });

        document.querySelectorAll('.delete-home-photo').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const photoId = parseInt(this.dataset.id);
                if (confirm('确定要删除这张照片吗？')) {
                    deleteHomePhoto(photoId);
                }
            });
        });
    }

    // 删除首页照片
    function deleteHomePhoto(photoId) {
        appData.homePhotos = appData.homePhotos.filter(photo => photo.id !== photoId);
        saveDataToStorage();
        loadHomePhotos();
    }

    // 初始化关于她页面
    function initAboutHerPage() {
        const aboutContainer = document.getElementById('about-her-container');
        if (!aboutContainer) return;

        aboutContainer.innerHTML = '';

        // 基本信息卡片
        const basicInfoCard = createAboutCard('基本信息', appData.aboutHer.basicInfo, 'basicInfo');
        aboutContainer.appendChild(basicInfoCard);

        // 喜好卡片
        const likesCard = createAboutCard('她的喜好', appData.aboutHer.likes, 'likes');
        aboutContainer.appendChild(likesCard);

        // 不喜欢卡片
        const dislikesCard = createAboutCard('她的不喜欢', appData.aboutHer.dislikes, 'dislikes');
        aboutContainer.appendChild(dislikesCard);

        // 时间线卡片
        const timelineCard = createTimelineCard();
        aboutContainer.appendChild(timelineCard);
    }

    // 创建关于卡片
    function createAboutCard(title, items, category) {
        const card = document.createElement('div');
        card.className = 'about-card';

        let itemsHtml = '';
        items.forEach((item, index) => {
            itemsHtml += `
                <li>
                    <strong>${item.label}：</strong>
                    <span>${formatNameUsage(item.value)}</span>
                    <div>
                        <button class="edit-btn edit-about-item" data-category="${category}" data-index="${index}" title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn delete-about-item" data-category="${category}" data-index="${index}" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </li>
            `;
        });

        card.innerHTML = `
            <div class="about-header">
                <div class="about-icon">
                    <i class="${category === 'basicInfo' ? 'fas fa-user' : category === 'likes' ? 'fas fa-heart' : 'fas fa-thumbs-down'}"></i>
                </div>
                <h3 class="about-title">${title}</h3>
                <button class="btn add-btn add-about-item" data-category="${category}">
                    <i class="fas fa-plus"></i> 添加
                </button>
            </div>
            <div class="about-content">
                <ul>${itemsHtml}</ul>
            </div>
        `;

        // 添加事件监听
        card.querySelectorAll('.edit-about-item').forEach(btn => {
            btn.addEventListener('click', function() {
                const category = this.dataset.category;
                const index = parseInt(this.dataset.index);
                openEditAboutItemModal(category, index);
            });
        });

        card.querySelectorAll('.delete-about-item').forEach(btn => {
            btn.addEventListener('click', function() {
                const category = this.dataset.category;
                const index = parseInt(this.dataset.index);
                if (confirm('确定要删除这项内容吗？')) {
                    deleteAboutItem(category, index);
                }
            });
        });

        const addAboutItemBtn = card.querySelector('.add-about-item');
        if (addAboutItemBtn) {
            addAboutItemBtn.addEventListener('click', function() {
                const category = this.dataset.category;
                openEditAboutItemModal(category, -1);
            });
        }

        return card;
    }

    // 格式化名字使用（根据上下文替换名字）
    function formatNameUsage(text) {
        // 在关于她页面，主要使用"芬"
        return text
            .replace(/她/g, '芬')
            .replace(/女孩/g, '芬')
            .replace(/饭饭/g, '芬')
            .replace(/冷/g, '芬')
            .replace(/茶泡饭/g, '芬');
    }

    // 创建时间线卡片
    function createTimelineCard() {
        const card = document.createElement('div');
        card.className = 'about-card relationship-timeline';

        let timelineHtml = '';
        appData.aboutHer.timeline.forEach((item, index) => {
            const isOdd = index % 2 === 0;

            // 格式化内容中的名字
            const formattedContent = formatNameUsage(item.content);

            timelineHtml += `
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-date">
                            <i class="fas fa-calendar-day"></i>
                            ${item.date}
                            <div style="margin-left: auto;">
                                <button class="edit-btn edit-timeline-item" data-index="${index}" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-btn delete-timeline-item" data-index="${index}" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <h4>${item.title}</h4>
                        <p>${formattedContent}</p>
                    </div>
                </div>
            `;
        });

        card.innerHTML = `
            <div class="about-header">
                <div class="about-icon">
                    <i class="fas fa-history"></i>
                </div>
                <h3 class="about-title">我们的故事时间线</h3>
                <button class="btn add-btn" id="add-timeline-item">
                    <i class="fas fa-plus"></i> 添加时间线
                </button>
            </div>
            <div class="timeline">
                ${timelineHtml}
            </div>
        `;

        // 添加事件监听
        card.querySelectorAll('.edit-timeline-item').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                openEditTimelineModal(index);
            });
        });

        card.querySelectorAll('.delete-timeline-item').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                if (confirm('确定要删除这个时间线项目吗？')) {
                    deleteTimelineItem(index);
                }
            });
        });

        const addTimelineBtn = card.querySelector('#add-timeline-item');
        if (addTimelineBtn) {
            addTimelineBtn.addEventListener('click', function() {
                openEditTimelineModal(-1);
            });
        }

        return card;
    }

    // 打开编辑关于她项目的模态框
    function openEditAboutItemModal(category, index) {
        const modal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        if (!modal || !modalTitle || !modalBody) return;

        const isNew = index === -1;
        const item = isNew ? { label: '', value: '' } : appData.aboutHer[category][index];

        modalTitle.textContent = isNew ? `添加${getCategoryName(category)}` : `编辑${getCategoryName(category)}`;

        modalBody.innerHTML = `
            <div class="form-group">
                <label for="editLabel">标签</label>
                <input type="text" id="editLabel" class="form-control" value="${item.label}">
            </div>
            <div class="form-group">
                <label for="editValue">内容</label>
                <textarea id="editValue" class="form-control" rows="3">${item.value}</textarea>
            </div>
            <div style="text-align: right;">
                <button class="btn btn-secondary" id="cancelEditBtn">取消</button>
                <button class="btn btn-primary" id="saveEditBtn">保存</button>
            </div>
        `;

        modal.style.display = 'flex';
        const editLabel = document.getElementById('editLabel');
        if (editLabel) editLabel.focus();

        // 保存按钮事件
        const saveEditBtn = document.getElementById('saveEditBtn');
        if (saveEditBtn) {
            saveEditBtn.addEventListener('click', function() {
                const editLabel = document.getElementById('editLabel');
                const editValue = document.getElementById('editValue');
                
                if (!editLabel || !editValue) return;
                
                const label = editLabel.value.trim();
                const value = editValue.value.trim();

                if (!label || !value) {
                    alert('请填写完整信息');
                    return;
                }

                if (isNew) {
                    appData.aboutHer[category].push({ label, value });
                } else {
                    appData.aboutHer[category][index] = { label, value };
                }

                saveDataToStorage();
                initAboutHerPage();
                modal.style.display = 'none';
            });
        }

        // 取消按钮事件
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        if (cancelEditBtn) {
            cancelEditBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }
    }

    // 获取分类名称
    function getCategoryName(category) {
        switch(category) {
            case 'basicInfo': return '基本信息';
            case 'likes': return '喜好';
            case 'dislikes': return '不喜欢';
            default: return '项目';
        }
    }

    // 删除关于她项目
    function deleteAboutItem(category, index) {
        appData.aboutHer[category].splice(index, 1);
        saveDataToStorage();
        initAboutHerPage();
    }

    // 打开编辑时间线模态框
    function openEditTimelineModal(index) {
        const modal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        if (!modal || !modalTitle || !modalBody) return;

        const isNew = index === -1;
        const item = isNew ? { date: '', title: '', content: '' } : appData.aboutHer.timeline[index];

        modalTitle.textContent = isNew ? '添加时间线' : '编辑时间线';

        modalBody.innerHTML = `
            <div class="form-group">
                <label for="timelineDate">日期</label>
                <input type="text" id="timelineDate" class="form-control" value="${item.date}" placeholder="例如：2025年4月6日">
            </div>
            <div class="form-group">
                <label for="timelineTitle">标题</label>
                <input type="text" id="timelineTitle" class="form-control" value="${item.title}">
            </div>
            <div class="form-group">
                <label for="timelineContent">内容</label>
                <textarea id="timelineContent" class="form-control" rows="4">${item.content}</textarea>
            </div>
            <div style="text-align: right;">
                <button class="btn btn-secondary" id="cancelTimelineBtn">取消</button>
                <button class="btn btn-primary" id="saveTimelineBtn">保存</button>
            </div>
        `;

        modal.style.display = 'flex';
        const timelineDate = document.getElementById('timelineDate');
        if (timelineDate) timelineDate.focus();

        // 保存按钮事件
        const saveTimelineBtn = document.getElementById('saveTimelineBtn');
        if (saveTimelineBtn) {
            saveTimelineBtn.addEventListener('click', function() {
                const timelineDate = document.getElementById('timelineDate');
                const timelineTitle = document.getElementById('timelineTitle');
                const timelineContent = document.getElementById('timelineContent');
                
                if (!timelineDate || !timelineTitle || !timelineContent) return;
                
                const date = timelineDate.value.trim();
                const title = timelineTitle.value.trim();
                const content = timelineContent.value.trim();

                if (!date || !title || !content) {
                    alert('请填写完整信息');
                    return;
                }

                if (isNew) {
                    appData.aboutHer.timeline.push({ date, title, content });
                } else {
                    appData.aboutHer.timeline[index] = { date, title, content };
                }

                saveDataToStorage();
                initAboutHerPage();
                modal.style.display = 'none';
            });
        }

        // 取消按钮事件
        const cancelTimelineBtn = document.getElementById('cancelTimelineBtn');
        if (cancelTimelineBtn) {
            cancelTimelineBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }
    }

    // 删除时间线项目
    function deleteTimelineItem(index) {
        appData.aboutHer.timeline.splice(index, 1);
        saveDataToStorage();
        initAboutHerPage();
    }

    // 初始化日记功能 - 增强版
    function initDiary() {
        const diaryEntries = document.getElementById('diaryEntries');
        const diaryTitle = document.getElementById('diaryTitle');
        const diaryContent = document.getElementById('diaryContent');
        const diaryDate = document.getElementById('diaryDate');
        const diaryMood = document.getElementById('diaryMood');
        const saveDiaryBtn = document.getElementById('saveDiaryBtn');
        const saveDraftBtn = document.getElementById('saveDraftBtn');
        const deleteDiaryBtn = document.getElementById('deleteDiaryBtn');
        const newDiaryBtn = document.getElementById('new-diary-btn');
        const diarySearch = document.getElementById('diarySearch');
        const diaryFilterTags = document.getElementById('diaryFilterTags');
        const attachmentUpload = document.getElementById('attachmentUpload');
        const attachmentUploadArea = document.getElementById('attachmentUploadArea');
        const addAttachmentBtn = document.getElementById('addAttachmentBtn');
        const tagsContainer = document.getElementById('tagsContainer');
        const tagInput = document.getElementById('tagInput');
        const backupDiariesBtn = document.getElementById('backup-diaries-btn');
        const restoreDiariesBtn = document.getElementById('restore-diaries-btn');
        const printDiaryBtn = document.getElementById('printDiaryBtn');
        const exportDiaryBtn = document.getElementById('exportDiaryBtn');

        // 富文本工具栏按钮
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const underlineBtn = document.getElementById('underlineBtn');
        const insertImageBtn = document.getElementById('insertImageBtn');
        const insertDateBtn = document.getElementById('insertDateBtn');
        const clearFormatBtn = document.getElementById('clearFormatBtn');

        // 初始化图片查看器
        initImageViewer();

        // 初始化富文本工具栏
        initToolbar();

        // 更新日记统计
        updateDiaryStats();

        // 加载日记列表
        function loadDiaryEntries() {
            if (!diaryEntries) return;

            diaryEntries.innerHTML = '';

            // 按日期降序排序
            let filteredDiaries = [...appData.diaries];

            // 应用标签筛选
            if (currentFilterTag) {
                filteredDiaries = filteredDiaries.filter(diary =>
                    diary.tags && diary.tags.includes(currentFilterTag)
                );
            }

            // 应用搜索筛选
            if (currentSearchQuery) {
                const query = currentSearchQuery.toLowerCase();
                filteredDiaries = filteredDiaries.filter(diary =>
                    diary.title.toLowerCase().includes(query) ||
                    diary.content.toLowerCase().includes(query) ||
                    (diary.tags && diary.tags.some(tag => tag.toLowerCase().includes(query)))
                );
            }

            filteredDiaries.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredDiaries.length === 0) {
                diaryEntries.innerHTML = `
                    <li style="text-align: center; padding: 30px; color: #777;">
                        <i class="fas fa-book" style="font-size: 2rem; margin-bottom: 10px; color: var(--primary-pink);"></i>
                        <p>${currentFilterTag || currentSearchQuery ? '没有找到符合条件的日记' : '还没有日记，点击"新建日记"开始记录吧！'}</p>
                        ${currentFilterTag || currentSearchQuery ? '<button class="btn btn-secondary" id="clearFilterBtn" style="margin-top: 10px; padding: 5px 15px;">清除筛选</button>' : ''}
                    </li>
                `;

                // 清除筛选按钮
                const clearFilterBtn = document.getElementById('clearFilterBtn');
                if (clearFilterBtn) {
                    clearFilterBtn.addEventListener('click', function() {
                        currentFilterTag = null;
                        currentSearchQuery = '';
                        if (diarySearch) diarySearch.value = '';
                        loadDiaryEntries();
                        updateTagFilters();
                    });
                }

                return;
            }

            filteredDiaries.forEach(diary => {
                const diaryEntry = document.createElement('li');
                diaryEntry.className = 'diary-entry';
                diaryEntry.dataset.id = diary.id;

                if (appData.currentDiaryId === diary.id) {
                    diaryEntry.classList.add('active');
                }

                const date = new Date(diary.date);
                const formattedDate = `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日`;

                // 获取第一张图片作为缩略图
                let thumbnailHtml = '<i class="fas fa-image"></i>';
                if (diary.images && diary.images.length > 0) {
                    thumbnailHtml = `<img src="${diary.images[0]}" alt="日记图片" onerror="this.parentElement.innerHTML='<i class=\\"fas fa-image\\"></i>'">`;
                }

                // 显示标签
                let tagsHtml = '';
                if (diary.tags && diary.tags.length > 0) {
                    tagsHtml = `<div class="diary-tags">${diary.tags.slice(0, 3).join(', ')}${diary.tags.length > 3 ? '...' : ''}</div>`;
                }

                // 移除HTML标签，只保留文本预览
                const plainContent = diary.content.replace(/<[^>]*>/g, '');
                const preview = plainContent.length > 60 ? plainContent.substring(0, 60) + '...' : plainContent;

                diaryEntry.innerHTML = `
                    <div class="diary-entry-thumbnail">
                        ${thumbnailHtml}
                    </div>
                    <div class="diary-entry-content">
                        <div class="diary-date">
                            <span>${formattedDate} ${diary.isDraft ? '<span style="color:#ff7eb3;">(草稿)</span>' : ''}</span>
                            <span class="diary-mood">${diary.mood || ''}</span>
                        </div>
                        <div class="diary-preview">${diary.title || '无标题日记'}</div>
                        <div style="font-size: 0.85rem; color: #777; margin-bottom: 5px;">${preview}</div>
                        ${tagsHtml}
                    </div>
                `;

                diaryEntry.addEventListener('click', () => {
                    document.querySelectorAll('.diary-entry').forEach(entry => {
                        entry.classList.remove('active');
                    });
                    diaryEntry.classList.add('active');

                    loadDiaryIntoEditor(diary.id);
                });

                diaryEntries.appendChild(diaryEntry);
            });

            // 如果没有选中的日记，选中第一个
            if (!appData.currentDiaryId && filteredDiaries.length > 0) {
                appData.currentDiaryId = filteredDiaries[0].id;
                if (diaryEntries.firstChild) {
                    diaryEntries.firstChild.click();
                }
            }
        }

        // 加载日记到编辑器
        function loadDiaryIntoEditor(diaryId) {
            const diary = appData.diaries.find(d => d.id === diaryId);
            if (!diary) return;

            appData.currentDiaryId = diaryId;
            if (diaryDate) diaryDate.value = diary.date;
            if (diaryTitle) diaryTitle.value = diary.title;
            if (diaryContent) diaryContent.innerHTML = diary.content;
            if (diaryMood) diaryMood.value = diary.mood || '';

            // 加载图片附件
            loadAttachments(diary.images || []);

            // 加载标签
            loadTags(diary.tags || []);

            // 滚动到编辑器顶部
            const diaryEditor = document.querySelector('.diary-editor');
            if (diaryEditor) {
                diaryEditor.scrollTop = 0;
            }
        }

        // 加载图片附件
        function loadAttachments(images) {
            const attachmentsGrid = document.getElementById('attachmentsGrid');
            if (!attachmentsGrid) return;

            attachmentsGrid.innerHTML = '';

            images.forEach((image, index) => {
                const attachmentItem = document.createElement('div');
                attachmentItem.className = 'attachment-item';
                attachmentItem.innerHTML = `
                    <img src="${image}" alt="附件 ${index + 1}" onclick="viewImage('${image}')">
                    <button class="attachment-remove" data-index="${index}">&times;</button>
                `;
                attachmentsGrid.appendChild(attachmentItem);
            });

            // 添加上传区域
            if (attachmentUploadArea) {
                attachmentsGrid.appendChild(attachmentUploadArea);
            }

            // 添加删除事件监听
            document.querySelectorAll('.attachment-remove').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.dataset.index);
                    removeAttachment(index);
                });
            });
        }

        // 删除附件
        function removeAttachment(index) {
            if (!appData.currentDiaryId) return;

            const diaryIndex = appData.diaries.findIndex(d => d.id === appData.currentDiaryId);
            if (diaryIndex !== -1) {
                appData.diaries[diaryIndex].images.splice(index, 1);
                saveDataToStorage();
                loadAttachments(appData.diaries[diaryIndex].images);
            }
        }

        // 加载标签
        function loadTags(tags) {
            if (!tagsContainer) return;
            
            tagsContainer.innerHTML = '';

            tags.forEach((tag, index) => {
                const tagElement = document.createElement('div');
                tagElement.className = 'diary-tag';
                tagElement.innerHTML = `
                    ${tag}
                    <button class="tag-remove" data-index="${index}">&times;</button>
                `;
                tagsContainer.appendChild(tagElement);
            });

            // 添加删除事件监听
            document.querySelectorAll('.tag-remove').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    removeTag(index);
                });
            });
        }

        // 删除标签
        function removeTag(index) {
            if (!appData.currentDiaryId) return;

            const diaryIndex = appData.diaries.findIndex(d => d.id === appData.currentDiaryId);
            if (diaryIndex !== -1) {
                appData.diaries[diaryIndex].tags.splice(index, 1);
                saveDataToStorage();
                loadTags(appData.diaries[diaryIndex].tags);
                updateAllTags();
                updateTagFilters();
            }
        }

        // 初始化富文本工具栏
        function initToolbar() {
            // 加粗
            if (boldBtn) {
                boldBtn.addEventListener('click', function() {
                    document.execCommand('bold');
                    updateToolbarButtons();
                });
            }

            // 斜体
            if (italicBtn) {
                italicBtn.addEventListener('click', function() {
                    document.execCommand('italic');
                    updateToolbarButtons();
                });
            }

            // 下划线
            if (underlineBtn) {
                underlineBtn.addEventListener('click', function() {
                    document.execCommand('underline');
                    updateToolbarButtons();
                });
            }

            // 插入图片
            if (insertImageBtn) {
                insertImageBtn.addEventListener('click', function() {
                    const imageUrl = prompt('请输入图片URL:');
                    if (imageUrl) {
                        document.execCommand('insertImage', false, imageUrl);
                    }
                });
            }

            // 插入日期
            if (insertDateBtn) {
                insertDateBtn.addEventListener('click', function() {
                    const now = new Date();
                    const dateStr = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                    document.execCommand('insertText', false, dateStr);
                });
            }

            // 清除格式
            if (clearFormatBtn) {
                clearFormatBtn.addEventListener('click', function() {
                    document.execCommand('removeFormat');
                    updateToolbarButtons();
                });
            }

            // 监听选择变化，更新工具栏按钮状态
            if (diaryContent) {
                diaryContent.addEventListener('mouseup', updateToolbarButtons);
                diaryContent.addEventListener('keyup', updateToolbarButtons);
            }
        }

        // 更新工具栏按钮状态
        function updateToolbarButtons() {
            if (!boldBtn || !italicBtn || !underlineBtn) return;

            // 检查当前选区是否应用了这些样式
            boldBtn.classList.toggle('active', document.queryCommandState('bold'));
            italicBtn.classList.toggle('active', document.queryCommandState('italic'));
            underlineBtn.classList.toggle('active', document.queryCommandState('underline'));
        }

        // 初始化图片查看器
        function initImageViewer() {
            const imageViewer = document.getElementById('imageViewer');
            const closeImageViewer = document.getElementById('closeImageViewer');
            const viewerImage = document.getElementById('viewerImage');

            if (closeImageViewer) {
                closeImageViewer.addEventListener('click', function() {
                    if (imageViewer) imageViewer.style.display = 'none';
                });
            }

            // 点击背景关闭
            if (imageViewer) {
                imageViewer.addEventListener('click', function(e) {
                    if (e.target === imageViewer) {
                        imageViewer.style.display = 'none';
                    }
                });
            }
        }

        // 查看图片（全局函数，供onclick调用）
        window.viewImage = function(imageUrl) {
            const imageViewer = document.getElementById('imageViewer');
            const viewerImage = document.getElementById('viewerImage');

            if (imageViewer && viewerImage) {
                viewerImage.src = imageUrl;
                imageViewer.style.display = 'flex';
            }
        };

        // 更新标签筛选器
        function updateTagFilters() {
            if (!diaryFilterTags) return;
            
            diaryFilterTags.innerHTML = '';

            // 添加"全部"选项
            const allTag = document.createElement('span');
            allTag.className = `diary-tag-filter ${!currentFilterTag ? 'active' : ''}`;
            allTag.textContent = '全部';
            allTag.addEventListener('click', function() {
                currentFilterTag = null;
                loadDiaryEntries();
                updateTagFilters();
            });
            diaryFilterTags.appendChild(allTag);

            // 添加所有标签
            appData.allTags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = `diary-tag-filter ${currentFilterTag === tag ? 'active' : ''}`;
                tagElement.textContent = tag;
                tagElement.addEventListener('click', function() {
                    currentFilterTag = tag;
                    loadDiaryEntries();
                    updateTagFilters();
                });
                diaryFilterTags.appendChild(tagElement);
            });
        }

        // 更新日记统计
        function updateDiaryStats() {
            const totalDiaries = document.getElementById('totalDiaries');
            const totalImages = document.getElementById('totalImages');
            const totalTags = document.getElementById('totalTags');
            const firstDiaryDate = document.getElementById('firstDiaryDate');

            if (!totalDiaries || !totalImages || !totalTags || !firstDiaryDate) return;

            // 计算统计
            const diaryCount = appData.diaries.length;
            const imageCount = appData.diaries.reduce((sum, diary) => sum + (diary.images ? diary.images.length : 0), 0);
            const tagCount = appData.allTags.length;

            // 找到第一篇日记的日期
            let firstDate = '-';
            if (appData.diaries.length > 0) {
                const dates = appData.diaries.map(d => new Date(d.date));
                const earliestDate = new Date(Math.min(...dates));
                firstDate = `${earliestDate.getMonth()+1}/${earliestDate.getDate()}`;
            }

            // 更新显示
            totalDiaries.textContent = diaryCount;
            totalImages.textContent = imageCount;
            totalTags.textContent = tagCount;
            firstDiaryDate.textContent = firstDate;
        }

        // 新建日记
        if (newDiaryBtn) {
            newDiaryBtn.addEventListener('click', () => {
                const today = new Date().toISOString().split('T')[0];
                const newDiary = {
                    id: appData.nextDiaryId++,
                    date: today,
                    title: '',
                    content: '',
                    mood: '',
                    images: [],
                    tags: [],
                    isDraft: true
                };

                appData.diaries.unshift(newDiary); // 添加到开头
                appData.currentDiaryId = newDiary.id;
                saveDataToStorage();
                loadDiaryEntries();

                // 清空编辑器
                if (diaryDate) diaryDate.value = today;
                if (diaryTitle) diaryTitle.value = '';
                if (diaryContent) diaryContent.innerHTML = '';
                if (diaryMood) diaryMood.value = '';
                loadAttachments([]);
                loadTags([]);

                // 更新统计
                updateDiaryStats();
                updateAllTags();
                updateTagFilters();

                // 聚焦标题输入框
                setTimeout(() => {
                    if (diaryTitle) diaryTitle.focus();
                }, 100);
            });
        }

        // 保存日记
        if (saveDiaryBtn) {
            saveDiaryBtn.addEventListener('click', () => {
                if (!appData.currentDiaryId) {
                    alert('请选择或创建一篇日记');
                    return;
                }

                if (!diaryTitle || !diaryContent) return;
                
                const title = diaryTitle.value.trim();
                const content = diaryContent.innerHTML;
                const date = diaryDate ? diaryDate.value : new Date().toISOString().split('T')[0];
                const mood = diaryMood ? diaryMood.value : '';

                if (!title || !content || content === '<br>') {
                    alert('请填写标题和内容');
                    return;
                }

                const diaryIndex = appData.diaries.findIndex(d => d.id === appData.currentDiaryId);
                if (diaryIndex !== -1) {
                    appData.diaries[diaryIndex].title = title;
                    appData.diaries[diaryIndex].content = content;
                    appData.diaries[diaryIndex].date = date;
                    appData.diaries[diaryIndex].mood = mood;
                    appData.diaries[diaryIndex].isDraft = false;

                    saveDataToStorage();
                    loadDiaryEntries();
                    updateDiaryStats();
                    alert('日记保存成功！');
                }
            });
        }

        // 保存草稿
        if (saveDraftBtn) {
            saveDraftBtn.addEventListener('click', () => {
                if (!appData.currentDiaryId) {
                    alert('请选择或创建一篇日记');
                    return;
                }

                if (!diaryTitle || !diaryContent) return;
                
                const title = diaryTitle.value.trim();
                const content = diaryContent.innerHTML;
                const date = diaryDate ? diaryDate.value : new Date().toISOString().split('T')[0];
                const mood = diaryMood ? diaryMood.value : '';

                const diaryIndex = appData.diaries.findIndex(d => d.id === appData.currentDiaryId);
                if (diaryIndex !== -1) {
                    appData.diaries[diaryIndex].title = title;
                    appData.diaries[diaryIndex].content = content;
                    appData.diaries[diaryIndex].date = date;
                    appData.diaries[diaryIndex].mood = mood;
                    appData.diaries[diaryIndex].isDraft = true;

                    saveDataToStorage();
                    loadDiaryEntries();
                    alert('草稿已保存！');
                }
            });
        }

        // 删除日记
        if (deleteDiaryBtn) {
            deleteDiaryBtn.addEventListener('click', () => {
                if (!appData.currentDiaryId) {
                    alert('请选择一篇日记');
                    return;
                }

                if (!confirm('确定要删除这篇日记吗？此操作不可撤销。')) {
                    return;
                }

                const diaryIndex = appData.diaries.findIndex(d => d.id === appData.currentDiaryId);
                if (diaryIndex !== -1) {
                    appData.diaries.splice(diaryIndex, 1);

                    // 重置当前日记ID
                    appData.currentDiaryId = null;
                    if (appData.diaries.length > 0) {
                        appData.currentDiaryId = appData.diaries[0].id;
                    }

                    saveDataToStorage();
                    loadDiaryEntries();
                    updateDiaryStats();
                    updateAllTags();
                    updateTagFilters();

                    // 清空编辑器
                    const today = new Date().toISOString().split('T')[0];
                    if (diaryDate) diaryDate.value = today;
                    if (diaryTitle) diaryTitle.value = '';
                    if (diaryContent) diaryContent.innerHTML = '';
                    if (diaryMood) diaryMood.value = '';
                    loadAttachments([]);
                    loadTags([]);

                    alert('日记已删除！');
                }
            });
        }

        // 日记搜索
        if (diarySearch) {
            diarySearch.addEventListener('input', function() {
                currentSearchQuery = this.value.trim();
                loadDiaryEntries();
            });
        }

        // 上传附件
        if (attachmentUploadArea && attachmentUpload) {
            attachmentUploadArea.addEventListener('click', function() {
                if (attachmentUpload) attachmentUpload.click();
            });

            if (addAttachmentBtn) {
                addAttachmentBtn.addEventListener('click', function() {
                    if (attachmentUpload) attachmentUpload.click();
                });
            }

            if (attachmentUpload) {
                attachmentUpload.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        const files = Array.from(this.files);
                        const promises = files.map(file => {
                            return new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    resolve(e.target.result);
                                };
                                reader.readAsDataURL(file);
                            });
                        });

                        Promise.all(promises).then(results => {
                            if (!appData.currentDiaryId) return;

                            const diaryIndex = appData.diaries.findIndex(d => d.id === appData.currentDiaryId);
                            if (diaryIndex !== -1) {
                                if (!appData.diaries[diaryIndex].images) {
                                    appData.diaries[diaryIndex].images = [];
                                }

                                results.forEach(imageData => {
                                    appData.diaries[diaryIndex].images.push(imageData);
                                });

                                saveDataToStorage();
                                loadAttachments(appData.diaries[diaryIndex].images);
                                updateDiaryStats();
                            }
                        });

                        // 重置文件输入
                        this.value = '';
                    }
                });
            }
        }

        // 标签输入
        if (tagInput) {
            tagInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const tag = this.value.trim();
                    if (tag && appData.currentDiaryId) {
                        const diaryIndex = appData.diaries.findIndex(d => d.id === appData.currentDiaryId);
                        if (diaryIndex !== -1) {
                            if (!appData.diaries[diaryIndex].tags) {
                                appData.diaries[diaryIndex].tags = [];
                            }

                            if (!appData.diaries[diaryIndex].tags.includes(tag)) {
                                appData.diaries[diaryIndex].tags.push(tag);
                                saveDataToStorage();
                                loadTags(appData.diaries[diaryIndex].tags);
                                updateAllTags();
                                updateTagFilters();
                            }

                            this.value = '';
                        }
                    }
                }
            });
        }

        // 备份日记
        if (backupDiariesBtn) {
            backupDiariesBtn.addEventListener('click', function() {
                const backupData = {
                    diaries: appData.diaries,
                    backupDate: new Date().toISOString(),
                    count: appData.diaries.length
                };

                const backupStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([backupStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `芬与萌日记备份_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert(`已备份 ${appData.diaries.length} 篇日记！`);
            });
        }

        // 恢复日记
        if (restoreDiariesBtn) {
            restoreDiariesBtn.addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';

                input.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        const file = this.files[0];
                        const reader = new FileReader();

                        reader.onload = function(e) {
                            try {
                                const backupData = JSON.parse(e.target.result);

                                if (!backupData.diaries || !Array.isArray(backupData.diaries)) {
                                    alert('备份文件格式不正确！');
                                    return;
                                }

                                if (confirm(`将恢复 ${backupData.diaries.length} 篇日记。这会覆盖现有的日记吗？\\n\\n点击"确定"添加备份的日记到现有日记后面，点击"取消"则替换所有日记。`)) {
                                    // 添加模式：将备份的日记添加到现有日记后面
                                    const maxId = Math.max(...appData.diaries.map(d => d.id), 0);
                                    backupData.diaries.forEach((diary, index) => {
                                        diary.id = maxId + index + 1;
                                        appData.diaries.push(diary);
                                    });
                                    appData.nextDiaryId = Math.max(...appData.diaries.map(d => d.id)) + 1;

                                    alert(`已添加 ${backupData.diaries.length} 篇日记！`);
                                } else {
                                    // 替换模式：用备份的日记替换现有日记
                                    appData.diaries = backupData.diaries;
                                    appData.nextDiaryId = Math.max(...appData.diaries.map(d => d.id)) + 1;

                                    alert(`已恢复 ${backupData.diaries.length} 篇日记，替换了原有日记！`);
                                }

                                saveDataToStorage();
                                loadDiaryEntries();
                                updateDiaryStats();
                                updateAllTags();
                                updateTagFilters();

                            } catch (error) {
                                console.error('恢复备份时出错:', error);
                                alert('恢复备份失败：文件格式不正确！');
                            }
                        };

                        reader.readAsText(file);
                    }
                });

                input.click();
            });
        }

        // 打印日记
        if (printDiaryBtn) {
            printDiaryBtn.addEventListener('click', function() {
                if (!appData.currentDiaryId) {
                    alert('请选择一篇日记');
                    return;
                }

                window.print();
            });
        }

        // 导出PDF（模拟）
        if (exportDiaryBtn) {
            exportDiaryBtn.addEventListener('click', function() {
                if (!appData.currentDiaryId) {
                    alert('请选择一篇日记');
                    return;
                }

                const diary = appData.diaries.find(d => d.id === appData.currentDiaryId);
                if (!diary) return;

                // 创建一个临时div来生成PDF内容
                const tempDiv = document.createElement('div');
                tempDiv.style.padding = '20px';
                tempDiv.style.fontFamily = "'Noto Sans SC', sans-serif";

                const date = new Date(diary.date);
                const formattedDate = `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日`;

                tempDiv.innerHTML = `
                    <h1 style="color: #9D4E8C; text-align: center; margin-bottom: 10px;">${diary.title}</h1>
                    <div style="text-align: center; color: #666; margin-bottom: 20px;">
                        <span>${formattedDate}</span>
                        ${diary.mood ? `<span style="margin-left: 10px;">${diary.mood}</span>` : ''}
                    </div>
                    <hr style="border: 1px solid #FF9EBC; margin-bottom: 20px;">
                    <div style="line-height: 1.6;">${diary.content}</div>
                    ${diary.tags && diary.tags.length > 0 ?
                        `<div style="margin-top: 20px;">
                            <strong>标签:</strong> ${diary.tags.join(', ')}
                        </div>` : ''}
                    <div style="margin-top: 30px; text-align: center; color: #777; font-size: 0.9rem;">
                        来自: 芬与萌的甜蜜空间
                    </div>
                `;

                document.body.appendChild(tempDiv);

                // 触发打印
                window.print();

                // 移除临时div
                document.body.removeChild(tempDiv);

                alert('日记已准备好打印/导出为PDF！');
            });
        }

        // 为第二个保存按钮添加事件
        const saveDiaryBtn2 = document.getElementById('saveDiaryBtn2');
        if (saveDiaryBtn2) {
            saveDiaryBtn2.addEventListener('click', () => {
                if (saveDiaryBtn) saveDiaryBtn.click();
            });
        }

        // 为第二个删除按钮添加事件
        const deleteDiaryBtn2 = document.getElementById('deleteDiaryBtn2');
        if (deleteDiaryBtn2) {
            deleteDiaryBtn2.addEventListener('click', () => {
                if (deleteDiaryBtn) deleteDiaryBtn.click();
            });
        }

        // 初始加载
        loadDiaryEntries();
        updateTagFilters();
    }

    // 初始化相册
    function initGallery() {
        const albumContainer = document.getElementById('albumContainer');
        const uploadBtn = document.getElementById('uploadBtn');
        const photoUpload = document.getElementById('photoUpload');

        // 加载相册
        function loadAlbums() {
            if (!albumContainer) return;

            albumContainer.innerHTML = '';

            if (appData.galleryAlbums.length === 0) {
                albumContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; background-color: rgba(255,255,255,0.7); border-radius: 15px;">
                        <i class="fas fa-images" style="font-size: 3rem; color: var(--primary-pink); margin-bottom: 20px;"></i>
                        <h3>还没有相册</h3>
                        <p>点击上方按钮上传照片创建相册吧！</p>
                    </div>
                `;
                return;
            }

            appData.galleryAlbums.forEach(album => {
                const albumItem = document.createElement('div');
                albumItem.className = 'album-item';

                // 显示标签
                let tagsHtml = '';
                if (album.tags && album.tags.length > 0) {
                    tagsHtml = `<div style="margin-top: 5px; font-size: 0.8rem; color: #777;">${album.tags.join(', ')}</div>`;
                }

                albumItem.innerHTML = `
                    <div class="album-cover">
                        <img src="${album.cover}" alt="${album.name}" onerror="this.src='https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?ixlib=rb-4.0.3&auto=format&fit=crop&w=687&q=80'">
                        <div style="position: absolute; top: 10px; right: 10px;">
                            <button class="edit-btn edit-album" data-id="${album.id}" title="编辑相册">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn delete-album" data-id="${album.id}" title="删除相册">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="album-info">
                        <h3>${album.name}</h3>
                        <p><i class="far fa-images"></i> ${album.photoCount} 张照片</p>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">${album.description}</p>
                        ${tagsHtml}
                    </div>
                `;

                albumContainer.appendChild(albumItem);
            });

            // 添加事件监听
            document.querySelectorAll('.edit-album').forEach(btn => {
                btn.addEventListener('click', function() {
                    const albumId = parseInt(this.dataset.id);
                    openEditAlbumModal(albumId);
                });
            });

            document.querySelectorAll('.delete-album').forEach(btn => {
                btn.addEventListener('click', function() {
                    const albumId = parseInt(this.dataset.id);
                    if (confirm('确定要删除这个相册吗？')) {
                        deleteAlbum(albumId);
                    }
                });
            });
        }

        // 上传照片
        if (uploadBtn && photoUpload) {
            uploadBtn.addEventListener('click', () => {
                photoUpload.click();
            });

            photoUpload.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        const newAlbum = {
                            id: appData.nextPhotoId++,
                            name: `新相册 ${appData.galleryAlbums.length + 1}`,
                            photoCount: 1,
                            cover: e.target.result,
                            description: '新创建的相册',
                            tags: ['新相册']
                        };

                        appData.galleryAlbums.unshift(newAlbum); // 添加到开头
                        saveDataToStorage();
                        loadAlbums();
                        alert('相册已创建！');

                        // 重置文件输入
                        photoUpload.value = '';
                    };

                    reader.readAsDataURL(file);
                }
            });
        }

        // 初始加载
        loadAlbums();
    }

    // 打开编辑相册模态框
    function openEditAlbumModal(albumId) {
        const modal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        const albumIndex = appData.galleryAlbums.findIndex(a => a.id === albumId);
        if (albumIndex === -1) return;

        const album = appData.galleryAlbums[albumIndex];

        modalTitle.textContent = '编辑相册';

        modalBody.innerHTML = `
            <div class="form-group">
                <label for="albumName">相册名称</label>
                <input type="text" id="albumName" class="form-control" value="${album.name}">
            </div>
            <div class="form-group">
                <label for="albumPhotoCount">照片数量</label>
                <input type="number" id="albumPhotoCount" class="form-control" value="${album.photoCount}" min="1">
            </div>
            <div class="form-group">
                <label for="albumCover">封面图片URL</label>
                <input type="text" id="albumCover" class="form-control" value="${album.cover}">
            </div>
            <div class="form-group">
                <label for="albumDescription">相册描述</label>
                <textarea id="albumDescription" class="form-control" rows="2">${album.description || ''}</textarea>
            </div>
            <div class="form-group">
                <label for="albumTags">标签（用逗号分隔）</label>
                <input type="text" id="albumTags" class="form-control" value="${album.tags ? album.tags.join(', ') : ''}">
            </div>
            <div style="text-align: right;">
                <button class="btn btn-secondary" id="cancelAlbumBtn">取消</button>
                <button class="btn btn-primary" id="saveAlbumBtn">保存</button>
            </div>
        `;

        modal.style.display = 'flex';
        const albumName = document.getElementById('albumName');
        if (albumName) albumName.focus();

        // 保存按钮事件
        const saveAlbumBtn = document.getElementById('saveAlbumBtn');
        if (saveAlbumBtn) {
            saveAlbumBtn.addEventListener('click', function() {
                const albumName = document.getElementById('albumName');
                const albumPhotoCount = document.getElementById('albumPhotoCount');
                const albumCover = document.getElementById('albumCover');
                const albumDescription = document.getElementById('albumDescription');
                const albumTags = document.getElementById('albumTags');
                
                if (!albumName || !albumPhotoCount || !albumCover || !albumDescription || !albumTags) return;
                
                const name = albumName.value.trim();
                const photoCount = parseInt(albumPhotoCount.value);
                const cover = albumCover.value.trim();
                const description = albumDescription.value.trim();
                const tags = albumTags.value.split(',').map(tag => tag.trim()).filter(tag => tag);

                if (!name || !cover) {
                    alert('请填写完整信息');
                    return;
                }

                appData.galleryAlbums[albumIndex] = {
                    ...album,
                    name,
                    photoCount,
                    cover,
                    description,
                    tags
                };

                saveDataToStorage();
                initGallery();
                modal.style.display = 'none';
            });
        }

        // 取消按钮事件
        const cancelAlbumBtn = document.getElementById('cancelAlbumBtn');
        if (cancelAlbumBtn) {
            cancelAlbumBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }
    }

    // 删除相册
    function deleteAlbum(albumId) {
        appData.galleryAlbums = appData.galleryAlbums.filter(album => album.id !== albumId);
        saveDataToStorage();
        initGallery();
    }

    // 初始化纪念日
    function initMilestones() {
        const milestonesContainer = document.getElementById('milestonesContainer');

        // 加载纪念日
        function loadMilestones() {
            if (!milestonesContainer) return;

            milestonesContainer.innerHTML = '';

            if (appData.milestones.length === 0) {
                milestonesContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; background-color: rgba(255,255,255,0.7); border-radius: 15px;">
                        <i class="fas fa-calendar-heart" style="font-size: 3rem; color: var(--primary-pink); margin-bottom: 20px;"></i>
                        <h3>还没有纪念日</h3>
                        <p>点击上方按钮添加纪念日吧！</p>
                    </div>
                `;
                return;
            }

            appData.milestones.forEach(milestone => {
                const milestoneCard = document.createElement('div');
                milestoneCard.className = 'milestone-card';
                milestoneCard.dataset.id = milestone.id;

                const counters = calculateMilestoneCounters(milestone);

                // 特别处理生日卡片
                if (milestone.title.includes('生日')) {
                    milestoneCard.innerHTML = createBirthdayCard(milestone, counters);
                } else {
                    milestoneCard.innerHTML = createNormalMilestoneCard(milestone, counters);
                }

                milestonesContainer.appendChild(milestoneCard);
            });

            // 添加事件监听
            document.querySelectorAll('.edit-milestone').forEach(btn => {
                btn.addEventListener('click', function() {
                    const milestoneId = parseInt(this.dataset.id);
                    openEditMilestoneModal(milestoneId);
                });
            });

            document.querySelectorAll('.delete-milestone').forEach(btn => {
                btn.addEventListener('click', function() {
                    const milestoneId = parseInt(this.dataset.id);
                    if (confirm('确定要删除这个纪念日吗？')) {
                        deleteMilestone(milestoneId);
                    }
                });
            });
        }

        // 创建生日卡片
        function createBirthdayCard(milestone, counters) {
            // 计算下一个生日
            const now = new Date();
            const birthDate = new Date(milestone.targetDate);
            let nextBirthday = new Date(now.getFullYear(), birthDate.getMonth(), birthDate.getDate());

            if (nextBirthday < now) {
                nextBirthday.setFullYear(nextBirthday.getFullYear() + 1);
            }

            const daysToBirthday = Math.ceil((nextBirthday - now) / (1000 * 60 * 60 * 24));

            let countersHtml = '';

            if (milestone.dateType === 'since') {
                // 出生至今的正计时
                countersHtml = `
                    <div class="counter-box">
                        <div class="counter-label">芬已来到这个世界</div>
                        <div class="counter-value">${counters.days}<span class="counter-unit">天</span></div>
                    </div>
                `;

                if (milestone.showHours) {
                    countersHtml += `
                        <div class="counter-box">
                            <div class="counter-label">与</div>
                            <div class="counter-value">${counters.hours}<span class="counter-unit">小时</span></div>
                        </div>
                    `;
                }

                // 添加距离下一个生日的倒计时
                countersHtml += `
                    <div class="counter-box" style="background-color: rgba(255, 158, 188, 0.2);">
                        <div class="counter-label">距离下一个生日还有</div>
                        <div class="counter-value">${daysToBirthday}<span class="counter-unit">天</span></div>
                    </div>
                `;
            } else {
                // 下一个生日倒计时
                countersHtml = `
                    <div class="counter-box">
                        <div class="counter-label">距离芬的下一个生日还有</div>
                        <div class="counter-value">${daysToBirthday}<span class="counter-unit">天</span></div>
                    </div>
                `;

                if (milestone.showHours) {
                    const hoursToBirthday = Math.ceil((nextBirthday - now) / (1000 * 60 * 60)) % 24;
                    countersHtml += `
                        <div class="counter-box">
                            <div class="counter-label">与</div>
                            <div class="counter-value">${hoursToBirthday}<span class="counter-unit">小时</span></div>
                        </div>
                    `;
                }
            }

            return `
                <div class="milestone-icon">
                    <i class="${milestone.icon}"></i>
                </div>
                <h3 class="milestone-title">${milestone.title}</h3>
                <div class="milestone-counters">
                    ${countersHtml}
                </div>
                <p class="milestone-date">${milestone.description || '芬的生日每年都会庆祝'}</p>
                <p class="milestone-date">生日: 2003年4月23日</p>
                <p class="milestone-date">下一个生日: ${nextBirthday.getFullYear()}年${nextBirthday.getMonth()+1}月${nextBirthday.getDate()}日</p>
                <div style="margin-top: 15px;">
                    <button class="edit-btn edit-milestone" data-id="${milestone.id}" title="编辑纪念日">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-btn delete-milestone" data-id="${milestone.id}" title="删除纪念日">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        // 创建普通纪念日卡片
        function createNormalMilestoneCard(milestone, counters) {
            let countersHtml = '';

            // 天数
            if (milestone.showDays) {
                countersHtml += `
                    <div class="counter-box">
                        <div class="counter-label">${milestone.dateType === 'since' ? '已过去' : '还有'}</div>
                        <div class="counter-value">${counters.days}<span class="counter-unit">天</span></div>
                    </div>
                `;
            }

            // 小时
            if (milestone.showHours) {
                countersHtml += `
                    <div class="counter-box">
                        <div class="counter-label">${milestone.dateType === 'since' ? '与' : '与'}</div>
                        <div class="counter-value">${counters.hours}<span class="counter-unit">小时</span></div>
                    </div>
                `;
            }

            // 分钟
            if (milestone.showMinutes) {
                countersHtml += `
                    <div class="counter-box">
                        <div class="counter-label">${milestone.dateType === 'since' ? '与' : '与'}</div>
                        <div class="counter-value">${counters.minutes}<span class="counter-unit">分钟</span></div>
                    </div>
                `;
            }

            const targetDate = new Date(milestone.targetDate);
            const formattedDate = `${targetDate.getFullYear()}年${targetDate.getMonth()+1}月${targetDate.getDate()}日`;

            return `
                <div class="milestone-icon">
                    <i class="${milestone.icon}"></i>
                </div>
                <h3 class="milestone-title">${milestone.title}</h3>
                <div class="milestone-counters">
                    ${countersHtml}
                </div>
                <p class="milestone-date">${milestone.description || ''}</p>
                <p class="milestone-date">${milestone.dateType === 'since' ? '从 ' + formattedDate + ' 开始' : '目标日期: ' + formattedDate}</p>
                <div style="margin-top: 15px;">
                    <button class="edit-btn edit-milestone" data-id="${milestone.id}" title="编辑纪念日">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-btn delete-milestone" data-id="${milestone.id}" title="删除纪念日">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }

        // 添加纪念日按钮
        const addMilestoneBtn = document.getElementById('add-milestone-btn');
        if (addMilestoneBtn) {
            addMilestoneBtn.addEventListener('click', function() {
                openEditMilestoneModal(-1);
            });
        }

        // 初始加载
        loadMilestones();
    }

    // 计算纪念日计数器
    function calculateMilestoneCounters(milestone) {
        let targetDate = new Date(milestone.targetDate);
        const now = new Date();

        // 处理生日每年的倒计时
        if (milestone.isYearly && milestone.dateType === 'until') {
            // 对于生日倒计时，计算到下一个生日的日期
            const birthDate = new Date(milestone.targetDate);
            let nextDate = new Date(now.getFullYear(), birthDate.getMonth(), birthDate.getDate());

            if (nextDate < now) {
                nextDate.setFullYear(nextDate.getFullYear() + 1);
            }

            targetDate = nextDate;
        }

        let diffMs;

        if (milestone.dateType === 'since') {
            // 正计时：从目标日期到现在已经过去的时间
            diffMs = now - targetDate;
        } else {
            // 倒计时：从现在到目标日期还有多少时间
            diffMs = targetDate - now;
        }

        // 确保是正数
        diffMs = Math.abs(diffMs);

        // 计算天数、小时、分钟
        const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

        return {
            days: days,
            hours: hours,
            minutes: minutes,
            targetDate: targetDate
        };
    }

    // 更新纪念日计数器
    function updateMilestoneCounters() {
        const milestoneCards = document.querySelectorAll('.milestone-card');

        milestoneCards.forEach(card => {
            const milestoneId = parseInt(card.dataset.id);
            const milestone = appData.milestones.find(m => m.id === milestoneId);

            if (milestone) {
                const counters = calculateMilestoneCounters(milestone);

                // 更新计数器显示
                const counterValues = card.querySelectorAll('.counter-value');
                let counterIndex = 0;

                // 天数
                if (milestone.showDays && counterValues[counterIndex]) {
                    counterValues[counterIndex].innerHTML = `${counters.days}<span class="counter-unit">天</span>`;
                    counterIndex++;
                }

                // 小时
                if (milestone.showHours && counterValues[counterIndex]) {
                    counterValues[counterIndex].innerHTML = `${counters.hours}<span class="counter-unit">小时</span>`;
                    counterIndex++;
                }

                // 分钟
                if (milestone.showMinutes && counterValues[counterIndex]) {
                    counterValues[counterIndex].innerHTML = `${counters.minutes}<span class="counter-unit">分钟</span>`;
                    counterIndex++;
                }

                // 特别更新生日卡片的额外信息
                if (milestone.title.includes('生日') && milestone.dateType === 'until') {
                    const now = new Date();
                    const birthDate = new Date(milestone.targetDate);
                    let nextBirthday = new Date(now.getFullYear(), birthDate.getMonth(), birthDate.getDate());

                    if (nextBirthday < now) {
                        nextBirthday.setFullYear(nextBirthday.getFullYear() + 1);
                    }

                    const daysToBirthday = Math.ceil((nextBirthday - now) / (1000 * 60 * 60 * 24));

                    // 更新下一个生日日期
                    const nextBirthdayElement = card.querySelector('.milestone-date:nth-last-child(2)');
                    if (nextBirthdayElement) {
                        nextBirthdayElement.textContent = `下一个生日: ${nextBirthday.getFullYear()}年${nextBirthday.getMonth()+1}月${nextBirthday.getDate()}日`;
                    }

                    // 更新倒计时天数（如果存在额外计数器）
                    const extraCounter = card.querySelector('.counter-box:last-child .counter-value');
                    if (extraCounter && extraCounter.textContent.includes('天')) {
                        extraCounter.innerHTML = `${daysToBirthday}<span class="counter-unit">天</span>`;
                    }
                }
            }
        });
    }

    // 打开编辑纪念日模态框
    function openEditMilestoneModal(milestoneId) {
        const modal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        const isNew = milestoneId === -1;
        let milestoneIndex = -1;
        let milestone = null;

        if (!isNew) {
            milestoneIndex = appData.milestones.findIndex(m => m.id === milestoneId);
            if (milestoneIndex === -1) return;
            milestone = appData.milestones[milestoneIndex];
        } else {
            milestone = {
                id: appData.nextMilestoneId++,
                title: '新纪念日',
                dateType: 'since',
                targetDate: new Date().toISOString().split('T')[0],
                icon: 'fas fa-heart',
                showDays: true,
                showHours: true,
                showMinutes: false,
                isYearly: false,
                description: ''
            };
        }

        modalTitle.textContent = isNew ? '添加纪念日' : '编辑纪念日';

        // 图标选项
        const iconOptions = [
            'fas fa-heart', 'fas fa-birthday-cake', 'fas fa-gamepad', 'fas fa-calendar-heart',
            'fas fa-gift', 'fas fa-ring', 'fas fa-star', 'fas fa-heartbeat', 'fas fa-kiss-wink-heart',
            'fas fa-baby', 'fas fa-users', 'fas fa-moon', 'fas fa-sun'
        ];

        let iconOptionsHtml = '';
        iconOptions.forEach(icon => {
            const selected = icon === milestone.icon ? 'selected' : '';
            iconOptionsHtml += `<option value="${icon}" ${selected}>${icon}</option>`;
        });

        modalBody.innerHTML = `
            <div class="form-group">
                <label for="milestoneTitle">纪念日标题</label>
                <input type="text" id="milestoneTitle" class="form-control" value="${milestone.title}">
            </div>
            <div class="form-group">
                <label for="milestoneDateType">计时类型</label>
                <select id="milestoneDateType" class="form-control">
                    <option value="since" ${milestone.dateType === 'since' ? 'selected' : ''}>正计时（从某天开始）</option>
                    <option value="until" ${milestone.dateType === 'until' ? 'selected' : ''}>倒计时（到某天还有）</option>
                </select>
            </div>
            <div class="form-group">
                <label for="milestoneTargetDate">目标日期</label>
                <input type="date" id="milestoneTargetDate" class="form-control" value="${milestone.targetDate}">
            </div>
            <div class="form-group">
                <label for="milestoneIcon">图标</label>
                <select id="milestoneIcon" class="form-control">
                    ${iconOptionsHtml}
                </select>
            </div>
            <div class="form-group">
                <label for="milestoneDescription">描述</label>
                <textarea id="milestoneDescription" class="form-control" rows="2">${milestone.description || ''}</textarea>
            </div>
            <div class="form-group">
                <label>显示选项</label>
                <div style="display: flex; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="showDays" ${milestone.showDays ? 'checked' : ''}>
                        显示天数
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="showHours" ${milestone.showHours ? 'checked' : ''}>
                        显示小时
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="showMinutes" ${milestone.showMinutes ? 'checked' : ''}>
                        显示分钟
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="isYearly" ${milestone.isYearly ? 'checked' : ''}>
                    每年重复（用于生日等每年庆祝的纪念日）
                </label>
            </div>
            <div style="text-align: right;">
                <button class="btn btn-secondary" id="cancelMilestoneBtn">取消</button>
                <button class="btn btn-primary" id="saveMilestoneBtn">保存</button>
            </div>
        `;

        modal.style.display = 'flex';
        const milestoneTitle = document.getElementById('milestoneTitle');
        if (milestoneTitle) milestoneTitle.focus();

        // 保存按钮事件
        const saveMilestoneBtn = document.getElementById('saveMilestoneBtn');
        if (saveMilestoneBtn) {
            saveMilestoneBtn.addEventListener('click', function() {
                const milestoneTitle = document.getElementById('milestoneTitle');
                const milestoneDateType = document.getElementById('milestoneDateType');
                const milestoneTargetDate = document.getElementById('milestoneTargetDate');
                const milestoneIcon = document.getElementById('milestoneIcon');
                const milestoneDescription = document.getElementById('milestoneDescription');
                const showDays = document.getElementById('showDays');
                const showHours = document.getElementById('showHours');
                const showMinutes = document.getElementById('showMinutes');
                const isYearly = document.getElementById('isYearly');
                
                if (!milestoneTitle || !milestoneDateType || !milestoneTargetDate || !milestoneIcon || 
                    !milestoneDescription || !showDays || !showHours || !showMinutes || !isYearly) return;
                
                const title = milestoneTitle.value.trim();
                const dateType = milestoneDateType.value;
                const targetDate = milestoneTargetDate.value;
                const icon = milestoneIcon.value;
                const description = milestoneDescription.value.trim();
                const showDaysChecked = showDays.checked;
                const showHoursChecked = showHours.checked;
                const showMinutesChecked = showMinutes.checked;
                const isYearlyChecked = isYearly.checked;

                if (!title || !targetDate) {
                    alert('请填写完整信息');
                    return;
                }

                if (isNew) {
                    appData.milestones.push({
                        id: milestone.id,
                        title,
                        dateType,
                        targetDate,
                        icon,
                        description,
                        showDays: showDaysChecked,
                        showHours: showHoursChecked,
                        showMinutes: showMinutesChecked,
                        isYearly: isYearlyChecked
                    });
                } else {
                    appData.milestones[milestoneIndex] = {
                        ...milestone,
                        title,
                        dateType,
                        targetDate,
                        icon,
                        description,
                        showDays: showDaysChecked,
                        showHours: showHoursChecked,
                        showMinutes: showMinutesChecked,
                        isYearly: isYearlyChecked
                    };
                }

                saveDataToStorage();
                initMilestones();
                modal.style.display = 'none';
            });
        }

        // 取消按钮事件
        const cancelMilestoneBtn = document.getElementById('cancelMilestoneBtn');
        if (cancelMilestoneBtn) {
            cancelMilestoneBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }
    }

    // 删除纪念日
    function deleteMilestone(milestoneId) {
        appData.milestones = appData.milestones.filter(m => m.id !== milestoneId);
        saveDataToStorage();
        initMilestones();
    }

    // 初始化模态框
    function initModals() {
        const editModal = document.getElementById('editModal');
        const closeModal = document.getElementById('closeModal');
        const imageModal = document.getElementById('imageModal');
        const closeImageModal = document.getElementById('closeImageModal');
        const cancelImageBtn = document.getElementById('cancelImageBtn');

        // 关闭编辑模态框
        if (closeModal) {
            closeModal.addEventListener('click', function() {
                if (editModal) editModal.style.display = 'none';
            });
        }

        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            if (event.target === editModal && editModal) {
                editModal.style.display = 'none';
            }
            if (event.target === imageModal && imageModal) {
                imageModal.style.display = 'none';
            }
            const passwordModal = document.getElementById('passwordModal');
            if (passwordModal && event.target === passwordModal) {
                passwordModal.style.display = 'none';
            }
        });

        // 关闭图片模态框
        if (closeImageModal) {
            closeImageModal.addEventListener('click', function() {
                if (imageModal) imageModal.style.display = 'none';
            });
        }

        if (cancelImageBtn) {
            cancelImageBtn.addEventListener('click', function() {
                if (imageModal) imageModal.style.display = 'none';
            });
        }

        // 图片保存按钮
        const saveImageBtn = document.getElementById('saveImageBtn');
        if (saveImageBtn) {
            saveImageBtn.addEventListener('click', saveImage);
        }

        // 图片文件上传处理
        const imageFile = document.getElementById('imageFile');
        if (imageFile) {
            imageFile.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        const imageUrl = document.getElementById('imageUrl');
                        if (imageUrl) imageUrl.value = e.target.result;
                    };

                    reader.readAsDataURL(file);
                }
            });
        }
    }

    // 打开图片模态框
    function openImageModal(context, photoId) {
        const modal = document.getElementById('imageModal');
        const imageUrl = document.getElementById('imageUrl');
        const imageTitle = document.getElementById('imageTitle');
        const imageDescription = document.getElementById('imageDescription');
        const imageFile = document.getElementById('imageFile');

        if (!modal || !imageUrl || !imageTitle || !imageDescription) return;

        // 重置表单
        imageUrl.value = '';
        imageTitle.value = '';
        imageDescription.value = '';
        if (imageFile) imageFile.value = '';

        // 设置编辑模式
        if (photoId) {
            const photoIndex = appData.homePhotos.findIndex(p => p.id === photoId);
            if (photoIndex !== -1) {
                const photo = appData.homePhotos[photoIndex];
                imageUrl.value = photo.url;
                imageTitle.value = photo.title;
                imageDescription.value = photo.description;
            }
        }

        appData.editingItem = { context, id: photoId };
        modal.style.display = 'flex';
        if (imageTitle) imageTitle.focus();
    }

    // 保存图片
    function saveImage() {
        const imageUrl = document.getElementById('imageUrl');
        const imageTitle = document.getElementById('imageTitle');
        const imageDescription = document.getElementById('imageDescription');
        const imageFile = document.getElementById('imageFile');

        if (!imageUrl || !imageTitle || !imageDescription) return;

        const url = imageUrl.value.trim();
        const title = imageTitle.value.trim();
        const description = imageDescription.value.trim();
        const file = imageFile ? imageFile.files[0] : null;

        let finalUrl = url;

        // 如果有上传文件，优先使用
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                finalUrl = e.target.result;
                saveImageData(finalUrl, title, description);
            };
            reader.readAsDataURL(file);
        } else {
            saveImageData(finalUrl, title, description);
        }
    }

    // 保存图片数据
    function saveImageData(url, title, description) {
        if (!url || !title) {
            alert('请至少提供图片URL和标题');
            return;
        }

        const { context, id } = appData.editingItem;

        if (context === 'home') {
            if (id) {
                // 编辑现有照片
                const photoIndex = appData.homePhotos.findIndex(p => p.id === id);
                if (photoIndex !== -1) {
                    appData.homePhotos[photoIndex] = {
                        id,
                        url,
                        title,
                        description
                    };
                }
            } else {
                // 添加新照片
                const newPhoto = {
                    id: appData.nextPhotoId++,
                    url,
                    title,
                    description
                };
                appData.homePhotos.unshift(newPhoto); // 添加到开头
            }

            saveDataToStorage();
            loadHomePhotos();
        }

        // 关闭模态框
        const imageModal = document.getElementById('imageModal');
        if (imageModal) {
            imageModal.style.display = 'none';
        }
    }

    // 初始化编辑按钮
    function initEditButtons() {
        // 编辑网站标题
        const editSiteTitleBtn = document.getElementById('edit-site-title');
        if (editSiteTitleBtn) {
            editSiteTitleBtn.addEventListener('click', function() {
                openTextEditModal('siteTitle', '网站标题', appData.siteTitle, function(value) {
                    appData.siteTitle = value;
                    const siteTitle = document.getElementById('site-title');
                    if (siteTitle) siteTitle.textContent = value;
                    saveDataToStorage();
                });
            });
        }

        // 编辑情侣名称
        const editCoupleNameBtn = document.getElementById('edit-couple-name');
        if (editCoupleNameBtn) {
            editCoupleNameBtn.addEventListener('click', function() {
                openTextEditModal('coupleName', '情侣名称', appData.coupleName, function(value) {
                    appData.coupleName = value;
                    const coupleNameText = document.getElementById('couple-name-text');
                    if (coupleNameText) coupleNameText.textContent = value;

                    // 更新底部的情侣名称
                    const nameParts = value.split('的');
                    if (nameParts.length > 0) {
                        const coupleName = nameParts[0];
                        const footerText = appData.footerText.replace(/游戏中的<span class='heartbeat'>[^<]*<\\/span>与<span class='heartbeat'>[^<]*<\\/span>，现实中的<span class='heartbeat'>[^<]*<\\/span>与<span class='heartbeat'>[^<]*<\\/span>/,
                            `游戏中的<span class='heartbeat'>${coupleName.split('与')[0]}</span>与<span class='heartbeat'>${coupleName.split('与')[1] || '萌'}</span>，现实中的<span class='heartbeat'>${coupleName.split('与')[0]}</span>与<span class='heartbeat'>${coupleName.split('与')[1] || '萌'}</span>`);
                        appData.footerText = footerText;
                        const footerTextElement = document.getElementById('footer-text');
                        if (footerTextElement) footerTextElement.innerHTML = footerText;
                    }

                    saveDataToStorage();
                });
            });
        }

        // 编辑首页描述
        const editTaglineBtn = document.getElementById('edit-tagline');
        if (editTaglineBtn) {
            editTaglineBtn.addEventListener('click', function() {
                openTextEditModal('tagline', '首页描述', appData.tagline, function(value) {
                    appData.tagline = value;
                    const taglineText = document.getElementById('tagline-text');
                    if (taglineText) taglineText.textContent = value;
                    saveDataToStorage();
                });
            });
        }

        // 编辑底部文字
        const editFooterBtn = document.getElementById('edit-footer');
        if (editFooterBtn) {
            editFooterBtn.addEventListener('click', function() {
                openFooterEditModal();
            });
        }

        // 编辑页面标题按钮
        const editButtons = [
            { id: 'edit-about-her-title', sectionId: 'about-her', title: '关于她标题' },
            { id: 'edit-diary-title', sectionId: 'diary', title: '恋爱日记标题' },
            { id: 'edit-gallery-title', sectionId: 'gallery', title: '甜蜜相册标题' },
            { id: 'edit-milestones-title', sectionId: 'milestones', title: '纪念日标题' },
            { id: 'edit-features-title', sectionId: 'special-features', title: '特别功能标题' }
        ];

        editButtons.forEach(button => {
            const btn = document.getElementById(button.id);
            if (btn) {
                btn.addEventListener('click', function() {
                    openSectionTitleEditModal(button.sectionId, button.title);
                });
            }
        });
    }

    // 打开文本编辑模态框
    function openTextEditModal(field, title, currentValue, callback) {
        const modal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        if (!modal || !modalTitle || !modalBody) return;

        modalTitle.textContent = `编辑${title}`;

        modalBody.innerHTML = `
            <div class="form-group">
                <label for="editText">${title}</label>
                <textarea id="editText" class="form-control" rows="4">${currentValue}</textarea>
            </div>
            <div style="text-align: right;">
                <button class="btn btn-secondary" id="cancelTextBtn">取消</button>
                <button class="btn btn-primary" id="saveTextBtn">保存</button>
            </div>
        `;

        modal.style.display = 'flex';
        const editText = document.getElementById('editText');
        if (editText) editText.focus();

        // 保存按钮事件
        const saveTextBtn = document.getElementById('saveTextBtn');
        if (saveTextBtn) {
            saveTextBtn.addEventListener('click', function() {
                const editText = document.getElementById('editText');
                if (!editText) return;

                const value = editText.value.trim();
                if (!value) {
                    alert('内容不能为空');
                    return;
                }

                callback(value);
                modal.style.display = 'none';
            });
        }

        // 取消按钮事件
        const cancelTextBtn = document.getElementById('cancelTextBtn');
        if (cancelTextBtn) {
            cancelTextBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }
    }

    // 打开底部编辑模态框
    function openFooterEditModal() {
        const modal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        if (!modal || !modalTitle || !modalBody) return;

        modalTitle.textContent = '编辑底部文字';

        // 从footerText中提取信息
        const footerText = appData.footerText;

        // 提取游戏中的名字
        const gameMatch = footerText.match(/游戏中的<span class='heartbeat'>([^<]*)<\\/span>与<span class='heartbeat'>([^<]*)<\\/span>/);
        const gameName1 = gameMatch ? gameMatch[1] : '饭饭';
        const gameName2 = gameMatch ? gameMatch[2] : '南書';

        // 提取现实中的名字
        const realityMatch = footerText.match(/现实中的<span class='heartbeat'>([^<]*)<\\/span>与<span class='heartbeat'>([^<]*)<\\/span>/);
        const realityName1 = realityMatch ? realityMatch[1] : '芬';
        const realityName2 = realityMatch ? realityMatch[2] : '萌';

        modalBody.innerHTML = `
            <div class="form-group">
                <label for="footerText">底部文字（年份会自动更新）</label>
                <input type="text" id="footerText" class="form-control" value="© ${new Date().getFullYear()} 芬与萌的甜蜜空间 | 游戏中的${gameName1}与${gameName2}，现实中的${realityName1}与${realityName2}">
                <small>使用 ${gameName1}, ${gameName2}, ${realityName1}, ${realityName2} 等名称</small>
            </div>
            <div class="form-group">
                <label for="footerQuote">底部引用语</label>
                <textarea id="footerQuote" class="form-control" rows="2">${appData.footerQuote}</textarea>
            </div>
            <div style="text-align: right;">
                <button class="btn btn-secondary" id="cancelFooterBtn">取消</button>
                <button class="btn btn-primary" id="saveFooterBtn">保存</button>
            </div>
        `;

        modal.style.display = 'flex';
        const footerTextInput = document.getElementById('footerText');
        if (footerTextInput) footerTextInput.focus();

        // 保存按钮事件
        const saveFooterBtn = document.getElementById('saveFooterBtn');
        if (saveFooterBtn) {
            saveFooterBtn.addEventListener('click', function() {
                const footerTextInput = document.getElementById('footerText');
                const footerQuoteInput = document.getElementById('footerQuote');

                if (!footerTextInput || !footerQuoteInput) return;

                const footerTextValue = footerTextInput.value.trim();
                const footerQuote = footerQuoteInput.value.trim();

                if (!footerTextValue || !footerQuote) {
                    alert('请填写完整信息');
                    return;
                }

                // 确保年份正确
                const currentYear = new Date().getFullYear();
                const finalFooterText = footerTextValue.replace(/© \\d{4}/, `© ${currentYear}`);

                appData.footerText = finalFooterText;
                appData.footerQuote = footerQuote;

                const footerTextElement = document.getElementById('footer-text');
                const footerQuoteElement = document.getElementById('footer-quote');
                
                if (footerTextElement) footerTextElement.innerHTML = finalFooterText;
                if (footerQuoteElement) footerQuoteElement.textContent = footerQuote;

                saveDataToStorage();
                modal.style.display = 'none';
            });
        }

        // 取消按钮事件
        const cancelFooterBtn = document.getElementById('cancelFooterBtn');
        if (cancelFooterBtn) {
            cancelFooterBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }
    }

    // 打开页面标题编辑模态框
    function openSectionTitleEditModal(sectionId, title) {
        const sectionTitleElement = document.querySelector(`#${sectionId} .section-title`);
        const currentTitle = sectionTitleElement ?
            sectionTitleElement.firstChild.textContent.replace('编辑', '').trim() : title;

        openTextEditModal(sectionId, title, currentTitle, function(value) {
            if (sectionTitleElement) {
                // 移除编辑按钮，然后添加回来
                const editButton = sectionTitleElement.querySelector('button');
                sectionTitleElement.firstChild.textContent = value + ' ';
                if (editButton) {
                    sectionTitleElement.appendChild(editButton);
                }
            }
        });
    }

    // 定期保存
    setInterval(function() {
        saveDataToStorage();
    }, 30000); // 每30秒保存一次
</script>

</body>
</html>
